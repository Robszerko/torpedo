<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Globális Torpedó - Bajnokok Ligája</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@800&family=Poppins:wght@400;600&display=swap');

        :root {
            --cell-bg: rgba(255, 255, 255, 0.05);
            --cell-border: #8e9eab;
            --text-color: #E0E5EC; --hit-color: #ff4757; --miss-color: #537895;
            --sunk-color: #343a40; --prize-color: #feca57; --premium-glow: #ffd700;
            --mine-color: #e84118; --intel-color: #00a8ff;
            --aid-color: #3742fa; --ammo-color: #4cd137;
        }

        body {
            font-family: 'Poppins', sans-serif; display: flex; align-items: center; justify-content: center;
            min-height: 100vh; color: var(--text-color); margin: 0; padding: 20px; box-sizing: border-box;
            background-image: linear-gradient(to bottom, rgba(9, 20, 27, 0.85), rgba(15, 32, 39, 0.9)), url('https://images.pexels.com/photos/220201/pexels-photo-220201.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
            background-size: cover; background-position: center center; background-attachment: fixed; background-repeat: no-repeat;
        }

        #game-container {
            width: 100%; max-width: 950px;
            background: transparent;
            padding: 0;
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr 260px;
            grid-template-areas: "main side";
        }

        #main-panel { grid-area: main; min-width: 320px; display: flex; flex-direction: column; gap: 20px; }
        #side-panel { grid-area: side; width: 260px; flex-shrink: 0; display: flex; flex-direction: column; gap: 20px;}

        #game-header { text-align: center; }
        #game-header h1 {
            font-family: 'Orbitron', sans-serif; font-size: clamp(2.5rem, 8vw, 4rem); color: white;
            margin: 0 0 5px 0; text-shadow: 0 0 10px var(--cell-border), 0 0 20px var(--cell-border);
        }
        #open-rules-modal-btn {
            background: none; border: none; color: var(--cell-border);
            font-family: 'Poppins', sans-serif; font-size: 0.85em;
            cursor: pointer; text-decoration: underline; padding: 0;
            opacity: 0.8; transition: opacity 0.2s;
        }
        #open-rules-modal-btn:hover { opacity: 1; color: var(--premium-glow); }

        #stats-panel { display: flex; justify-content: space-around; gap: 5px; text-align: center; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 15px; border: 1px solid rgba(142, 158, 171, 0.5); }
        .stat { background: none; border: none; padding: 5px; flex-grow: 1; }
        .stat h3 { margin: 0; font-size: 0.7em; color: var(--cell-border); text-transform: uppercase; font-weight: 400; }
        .stat p { margin: 2px 0 0 0; font-size: 1.2em; font-weight: 600; font-family: 'Orbitron'; }
        #premium-stat.active p { color: var(--premium-glow); animation: pulse 1.5s infinite; }

        #player-controls { display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        .player-info { font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; cursor: pointer; padding: 5px 10px; border: 2px solid transparent; border-radius: 10px; }
        .player-info.active { color: var(--premium-glow); transform: scale(1.1); text-shadow: 0 0 8px var(--premium-glow); }
        .player-info.locked { border-color: var(--premium-glow); box-shadow: 0 0 10px var(--premium-glow); }
        .lock-icon { margin-left: 5px; }
        #rename-players-btn { background-color: var(--cell-bg); border: 1px solid var(--cell-border); color: var(--text-color); padding: 8px 15px; border-radius: 10px; cursor: pointer; font-family: 'Poppins'; font-weight: 600; transition: all 0.2s; }
        #rename-players-btn:hover { background-color: rgba(142, 158, 171, 0.4); }

        #turn-indicator-bar {
            text-align: center; padding: 5px; font-family: 'Orbitron', sans-serif;
            font-size: 1.1em; color: var(--premium-glow); text-shadow: 0 0 8px var(--premium-glow);
            background: rgba(0,0,0,0.25); border-radius: 10px; margin-bottom: 10px;
            height: 20px; line-height: 20px; transition: opacity 0.3s;
        }

        #board-wrapper { position: relative; }
        .board-locked #game-board td:not(.shot) { cursor: not-allowed !important; }
        .board-locked #game-board td:not(.shot):hover { background-color: transparent; transform: none; }
        .sonar-active #game-board td:not(.shot) { cursor: crosshair !important; }
        .strike-active #game-board td:not(.shot) { cursor: crosshair !important; }

        #board-message-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-family: 'Orbitron', sans-serif; font-size: clamp(1.8rem, 8vw, 3rem); color: var(--premium-glow); text-shadow: 0 0 10px #000, 0 0 20px var(--premium-glow); pointer-events: none; opacity: 0; z-index: 10; text-align: center; text-transform: uppercase; line-height: 1.2; }

        #game-board { border-collapse: separate; border-spacing: 4px; margin: 0 auto; width: 100%; }
        #game-board th, #game-board td { width: clamp(28px, 6.5vw, 40px); height: clamp(28px, 6.5vw, 40px); text-align: center; font-family: 'Orbitron'; color: var(--cell-border); vertical-align: middle; user-select: none; }
        #game-board th { background: rgba(255, 255, 255, 0.03); border-radius: 8px; font-size: clamp(0.7rem, 2vw, 0.9rem); }
        #game-board td { background: transparent; border: 2px solid var(--cell-border); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative; }
        #game-board td:hover:not(.shot) { background-color: rgba(142, 158, 171, 0.3); transform: scale(1.05); }
        #game-board td.shot { cursor: not-allowed; } #game-board td.shot:hover { transform: none; }
        #game-board td.miss { background-color: var(--miss-color); }
        #game-board td.hit { background-color: var(--hit-color); animation: hit-shake 0.5s; }
        #game-board td.sunk { animation: sink-animation 1s forwards; }
        #game-board td.points { background-color: var(--prize-color); }
        #game-board td.mine { background-color: var(--mine-color); }
        #game-board td.intel { background-color: var(--intel-color); }
        #game-board td.ammo { background-color: var(--ammo-color); }
        #game-board td.aid { background-color: var(--aid-color); }
        #game-board td.sonar-reveal { animation: sonar-pulse 1.5s forwards; }
        @keyframes sonar-pulse { 0% { background-color: transparent; } 50% { background-color: rgba(255, 215, 0, 0.7); box-shadow: 0 0 15px var(--premium-glow); } 100% { background-color: transparent; } }

        #waiting-panel { display: none; text-align: center; padding: 20px; background: rgba(9, 20, 27, 0.9); border: 1px solid var(--premium-glow); border-radius: 20px; }
        #waiting-title { font-family: 'Orbitron'; font-size: 2em; color: var(--premium-glow); margin-bottom: 10px; }
        #waiting-info { font-family: 'Poppins'; font-size: 1.2em; margin: 15px 0; color: white; }
        #live-time-waiting { font-family: 'Orbitron'; font-size: 1.5em; color: var(--premium-glow); }
        #next-round-info { font-size: 1.2em; color: var(--text-color); margin-top: 15px; }
        #waiting-time { font-family: 'Orbitron'; font-size: 1.5em; color: var(--premium-glow); }

        .icon { width: 70%; height: 70%; vertical-align: middle; position: absolute; top: 15%; left: 15%; }

        .side-box { background: rgba(0,0,0,0.25); border: 1px solid var(--cell-border); border-radius: 15px; padding: 15px; }
        .side-box h2 { font-family: 'Orbitron'; text-align: center; color: var(--cell-border); border-bottom: 2px solid var(--cell-border); padding-bottom: 5px; margin-top: 0; font-size: 1.2em; }
        #fleet-list { list-style: none; padding: 0; margin: 0; }
        #fleet-list li { background: var(--cell-bg); padding: 8px; border-radius: 8px; margin-bottom: 8px; font-weight: 600; transition: all 0.3s; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; }
        #fleet-list li.found { border-color: var(--premium-glow); box-shadow: 0 0 8px var(--premium-glow); background-color: rgba(255, 215, 0, 0.1); }
        #fleet-list li.sunk { background-color: var(--sunk-color); color: #999; text-decoration: line-through; border-color: #555; box-shadow: none; }
        .veteran-star { color: var(--premium-glow); margin-right: 5px; font-size: 1.2em; }

        #leaderboard { padding: 15px; }
        .leaderboard-subheader { font-family: 'Orbitron'; color: var(--cell-border); text-align: center; font-size: 1em; margin: 15px 0 8px 0; padding-bottom: 4px; border-bottom: 1px solid var(--cell-border); }
        .leaderboard-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.95em; padding: 5px; border-radius: 8px; transition: all 0.3s ease; }
        .leaderboard-row span:first-child { font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 5px; }
        .leaderboard-row span:last-child { font-family: 'Orbitron'; font-weight: bold; font-size: 1.1em; color: var(--premium-glow); flex-shrink: 0; }
        .leaderboard-row.active-player-highlight { background-color: rgba(255, 215, 0, 0.15); box-shadow: 0 0 8px rgba(255, 215, 0, 0.5); }
        #last-week-champion-box { text-align: center; margin-top: 15px; }
        #last-week-champion-box h4 { margin: 0 0 5px 0; color: var(--cell-border); font-weight: 400; font-size: 0.9em; text-transform: uppercase; }
        #last-week-champion-name { font-family: 'Orbitron'; font-size: 1.3em; color: var(--premium-glow); text-shadow: 0 0 8px var(--premium-glow); }

        #new-map-button { display: none; width: 100%; margin-top: 15px; padding: 12px; font-size: 1em; font-weight: 700; font-family: 'Orbitron'; color: #000; background-color: var(--premium-glow); border: none; border-radius: 15px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 0 20px var(--premium-glow); }
        #new-map-button:hover { transform: scale(1.05); }

        #aids-container { background: rgba(0,0,0,0.25); border: 1px solid var(--cell-border); border-radius: 15px; padding: 15px; margin-top: 20px; }
        #aids-container h2 { font-family: 'Orbitron'; text-align: center; color: var(--cell-border); border-bottom: 2px solid var(--cell-border); padding-bottom: 5px; margin-top: 0; font-size: 1.2em; }
        #aid-items-stored { display: flex; flex-direction: column; gap: 8px; }
        #aid-items-stored button { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 10px; background-color: var(--cell-bg); border: 1px solid var(--cell-border); color: var(--text-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-family: 'Poppins'; font-weight: 600; font-size: 1em; }
        #aid-items-stored button .aid-count { font-family: 'Orbitron'; font-size: 1.2em; color: var(--premium-glow); }
        #aid-items-stored button:hover:not(:disabled) { background-color: rgba(142, 158, 171, 0.4); }
        #aid-items-stored button:disabled { cursor: not-allowed; opacity: 0.5; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content { background: linear-gradient(145deg, #232526, #414345); border: 2px solid var(--premium-glow); border-radius: 20px; padding: 30px; text-align: center; color: white; width: 90%; max-width: 650px; transform: scale(0.9); transition: transform 0.3s; box-shadow: 0 0 30px var(--premium-glow); }
        .modal.visible .modal-content { transform: scale(1); }
        .modal-content h2 { font-family: 'Orbitron'; margin-top: 0; font-size: 2.2em; text-shadow: 0 0 10px var(--premium-glow); }
        .modal-content p { font-size: 1.1em; line-height: 1.6; }
        .modal-buttons { display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap; justify-content: center; }
        .modal-buttons button { flex-grow: 1; padding: 12px; font-size: 1em; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: transform 0.2s; min-width: 150px; }
        .modal-buttons button:hover { transform: scale(1.05); }
        .btn-confirm { background-color: var(--premium-glow); color: #000; } .btn-cancel { background-color: var(--sunk-color); color: #fff; }

        #rules-content, #summary-content { text-align: left; max-height: 60vh; overflow-y: auto; padding-right: 15px; }
        #rules-content h3, #summary-content h3 { color: var(--premium-glow); border-bottom: 1px solid var(--premium-glow); padding-bottom: 5px; margin-top: 20px; }
        #rules-content ul { padding-left: 20px; }

        #grand-prize-ships { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; perspective: 1000px; max-width: 550px; margin-left: auto; margin-right: auto; }
        #grand-prize-status { font-weight: bold; font-size: 1.2em; margin-top: 15px; }
        .flipper { position: relative; width: 85px; height: 85px; transition: transform 0.8s; transform-style: preserve-3d; }
        .ship-choice { background: none; border: none; cursor: pointer; padding: 0; } .ship-choice[disabled] { cursor: not-allowed; opacity: 0.5; }
        .ship-choice.is-flipped .flipper { transform: rotateY(180deg); }
        .front, .back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; flex-direction: column; border-radius: 15px; border: 2px solid var(--cell-border); }
        .front { background: rgba(0,0,0,0.3); }
        .front svg { width: 75px; height: 75px; fill: #ffffff; transition: all 0.3s ease; }
        .ship-choice:hover:not(:disabled) .front svg { fill: var(--premium-glow); transform: scale(1.1); }
        .back { transform: rotateY(180deg); font-family: 'Orbitron'; font-size: 1.1em; padding: 5px; line-height: 1.2; text-align: center; font-weight: bold; color: white; }
        .back.good { background: #006400; text-shadow: 0 0 8px #90ee90; } .back.bad { background: #8B0000; text-shadow: 0 0 8px #ff4757; } .back.neutral { background: #003366; text-shadow: 0 0 8px #00a8ff; } .back.jackpot { background: var(--premium-glow); color: #000; text-shadow: 0 0 10px #fff; }
        #grand-prize-result { margin-top: 15px; height: 40px; font-size: 1.3em; font-weight: bold; }

        @keyframes pulse { 50% { text-shadow: 0 0 15px var(--premium-glow); } }
        @keyframes hit-shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes sink-animation { 0% { background-color: var(--hit-color); transform: scale(1.1); border-color: white; } 50% { background-color: var(--hit-color); transform: scale(0.8); opacity: 0.8; } 100% { background-color: var(--sunk-color); transform: scale(1); opacity: 0.6; border-color: var(--sunk-color); } }
        @keyframes fade-in-out-zoom { 0% { transform: scale(0.8); opacity: 0; } 15% { transform: scale(1.1); opacity: 1; } 85% { transform: scale(1); opacity: 1; } 100% { transform: scale(0.9); opacity: 0; } }

        @media (max-width: 900px) {
            #game-container { display: flex; flex-direction: column; }
            #main-panel, #side-panel { width: 100%; }
            #main-panel { order: 1; }
            #side-panel { order: 2; display: flex; flex-direction: row; flex-wrap: wrap; gap: 15px; }
            .side-box { flex-grow: 1; min-width: calc(50% - 10px); }
            #fleet-status { order: 10; width: 100%; margin-top: 20px; }
            #new-map-button { order: 12; }
            #aids-container { order: 11; }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="main-panel">
            <div id="game-header">
                <h1>Globális Torpedó</h1>
                <button id="open-rules-modal-btn">Részletes Játékszabályzat</button>
            </div>
            <div id="stats-panel">
                <div id="shots-stat" class="stat"><h3>Lőszer</h3><p>60</p></div>
                <div id="premium-stat" class="stat"><h3>Prémium</h3><p>0</p></div>
                <div id="ships-left-stat" class="stat"><h3>Hajók</h3><p>0</p></div>
            </div>
            <div id="player-controls">
                <span id="player1-info" class="player-info"></span>
                <button id="rename-players-btn">Nevek Módosítása</button>
                <span id="player2-info" class="player-info"></span>
            </div>

            <div id="turn-indicator-bar"></div>

            <div id="board-wrapper">
                <div id="board-message-overlay"></div>
                <table id="game-board"></table>
            </div>

            <div id="aids-container" style="display: none;">
                <h2>Tartalék Segítségek (24 órás)</h2>
                <div id="aid-items-stored"></div>
            </div>

            <div id="waiting-panel">
                <h2 id="waiting-title">PIHENŐ A FEDÉLZETEN</h2>
                <div id="waiting-info">
                    <p>Aktuális idő: <span id="live-time-waiting"></span></p>
                    <p id="next-round-info">A következő portya <span id="waiting-time"></span>-kor indul.</p>
                </div>
            </div>
        </div>
        <div id="side-panel">
            <div id="leaderboard" class="side-box">
                <h2>Bajnokok Csarnoka</h2>
                <h3 class="leaderboard-subheader">Napi Pontok</h3>
                <div id="p1-leaderboard-daily" class="leaderboard-row">
                    <span id="p1-leaderboard-name-daily">Játékos 1</span>
                    <span id="p1-daily-score">0</span>
                </div>
                <div id="p2-leaderboard-daily" class="leaderboard-row">
                    <span id="p2-leaderboard-name-daily">Játékos 2</span>
                    <span id="p2-daily-score">0</span>
                </div>
                <h3 class="leaderboard-subheader">Heti Győzelmek</h3>
                <div id="p1-leaderboard-weekly" class="leaderboard-row">
                    <span id="p1-leaderboard-name-weekly">Játékos 1</span>
                    <span id="p1-weekly-wins">0</span>
                </div>
                 <div id="p2-leaderboard-weekly" class="leaderboard-row">
                    <span id="p2-leaderboard-name-weekly">Játékos 2</span>
                    <span id="p2-weekly-wins">0</span>
                </div>
                <div id="last-week-champion-box">
                    <h4>Előző Hét Bajnoka</h4>
                    <span id="last-week-champion-name">-</span>
                </div>
            </div>
            <div id="arsenal" class="side-box">
                <h2>Arzenál (Ebben a körben)</h2>
                <div id="aid-items">
                    <div class="aid-item"><button id="use-sonar">Szónár Bevetése (0)</button></div>
                    <div class="aid-item"><button id="use-strike">Célzott Csapás (0)</button></div>
                </div>
            </div>
            <div id="fleet-status" class="side-box">
                <h2>Flotta</h2><ul id="fleet-list"></ul>
            </div>
            <button id="new-map-button">Új Vizekre, Kapitány!</button>
        </div>
    </div>

    <!-- MODAL ABLAKOK -->
    <div id="rules-modal" class="modal"><div class="modal-content"><h2>Részletes Játékszabályzat</h2>
        <div id="rules-content">
            <h3>A Játék Célja</h3><p>A Globális Torpedó egy stratégiai játék, ahol a fő cél az ellenfél flottájának teljes megsemmisítése a játéktáblán. A játék igazi kihívása a hosszútávú pontgyűjtésben rejlik, amivel elnyerheted a "Nap Bajnoka" és a "Hét Bajnoka" címeket.</p>
            <h3>A Bajnoki Rendszer</h3><ul><li><strong>Napi Pontgyűjtés:</strong> Minden pont, amit szerzel, hozzáadódik a napi összesített pontszámodhoz. A pontok minden nap magyar idő szerint 23:59-kor kerülnek összesítésre és nullázásra.</li><li><strong>Napi Jelentés:</strong> Másnap, az első belépéskor egy ablak fogad, amely összegzi az előző nap eredményeit, a győztest, és a heti bajnokság aktuális állását.</li><li><strong>A Nap Bajnoka:</strong> Aki a nap végén több pontot gyűjt, elnyeri a címet és kap egy győzelmi pontot a heti versenyben.</li><li><strong>A Hét Bajnoka:</strong> Aki a hét során több napi győzelmet szerez, elnyeri a dicső címet.</li></ul>
            <h3>Játékmenet és Pontozás</h3><ul><li><strong>Találat és Prémium Lövés:</strong> Ha eltalálsz egy hajót, a mező pirosra vált. Jutalmul azonnal lőhetsz még egyet (Prémium Lövés). Addig folytathatod a lövést, amíg folyamatosan találsz.</li><li><strong>Kritikus Találat:</strong> Minden találatnál van egy kis esély, hogy <strong>+2 extra prémium lövést</strong> kapj!</li><li><strong>Hajó Elsüllyesztése:</strong> Egy hajó akkor süllyed el, ha minden részét eltaláltad. Ezért <strong>1 pont + a hajó méretének megfelelő pont</strong> jár. A süllyesztés után a lövés joga a tiéd marad.</li><li><strong>Veterán Hajó:</strong> A (<span class="veteran-star">★</span>) jelölt Veterán Hajó elsüllyesztéséért <strong>dupla pont</strong> jár!</li><li><strong>Szerencsevadász Bónusz:</strong> Ha egy speciális mező (pont, lőszer, segítség) felfedezése utáni első lövéseddel találsz, <strong>+2 bónusz pontot</strong> kapsz!</li></ul>
            <h3>Speciális Mezők és Események</h3><ul><li><strong>Pont Bónusz (Sárga):</strong> +5 vagy +10 pontot ad azonnal a napi pontjaidhoz. Megtalálása után újra te jössz.</li><li><strong>Akna (Piros):</strong> Azonnal elveszi az összes prémium lövésedet, és pontlevonással jár. A büntetés fokozódik: az elsőért <strong>-3</strong>, a másodikért <strong>-4</strong>, a harmadikért pedig <strong>-5</strong> pont.</li><li><strong>Lőszer (Zöld):</strong> +10 vagy +20 lőszert ad. Megtalálása után újra te jössz.</li><li><strong>Segítség (Lila):</strong> Szónárt vagy Célzott Csapást ad, amit az adott körben használhatsz fel az "Arzenál" panelről. Megtalálása után újra te jössz.</li><li><strong>Veterán Flotta:</strong> Ritka esemény a kör elején, amikor az egész flotta veteránná válik, így minden hajó dupla pontot ér.</li><li><strong>Tengeri Vihar:</strong> Ritka esemény, amikor a pályán a szokásos 3 helyett 5 akna van.</li></ul>
            <h3>Segítségek Használata</h3><ul><li><strong>Arzenál (körön belüli):</strong> A kör során talált segítségeket azonnal fel kell használnod.</li><li><strong>Tartalék Segítségek (24 órás):</strong> A Fődíj Játékban nyert segítségek a tábla alatt gyűlnek. Ezeket bármelyik körben aktiválhatod, amikor te következel. A nap végén (23:59) ezek a fel nem használt segítségek elvesznek.</li><li><strong>Szónár:</strong> Aktiválás után kattints egy mezőre. Egy 3x3-as területen ideiglenesen felfedi az elrejtett hajókat.</li><li><strong>Célzott Csapás:</strong> Aktiválás után a következő lövésed extra-precíz lesz. Ha eltalálsz egy hajót, ugyanúgy működik, mint egy normál találat. Ha mellémegy, megmondja, hogy a lövés sorában VAGY oszlopában van-e még felfedezetlen hajó.</li></ul>
            <h3>A Kör Vége: Fődíj Játék</h3><p>Miután az utolsó hajó is elsüllyedt, minden játékos választ egyet a 15 lap közül, ami extra pontokat, pontbüntetéseket, vagy 24 órán át felhasználható segítségeket rejthet.</p>
        </div>
        <div class="modal-buttons"><button id="btn-close-rules-modal" class="btn-confirm">Értem, Gyerünk Vissza!</button></div></div>
    </div>
    <div id="grand-prize-modal" class="modal"><div class="modal-content"><h2>FŐDÍJ JÁTÉK</h2><p id="grand-prize-status"></p><div id="grand-prize-ships"></div><div id="grand-prize-result"></div><div class="modal-buttons" style="margin-top: 15px;"><button id="btn-close-grand-prize" class="btn-confirm" style="display:none;">Tovább</button></div></div></div>
    <div id="out-of-ammo-modal" class="modal"><div class="modal-content"><h2>VÉSZHELYZET!</h2><p>Kapitány, kifogytunk a lőszerből! Ennek a körnek vége.</p><div class="modal-buttons"><button id="btn-ammo-end" class="btn-cancel">Harci Álláspont Elhagyása</button></div></div></div>
    <div id="summary-modal" class="modal"><div class="modal-content"><h2 id="summary-modal-title">Napi Jelentés</h2><div id="summary-content"></div><div class="modal-buttons"><button id="btn-close-summary-modal" class="btn-confirm">Rendben, Kapitány!</button></div></div></div>
    <div id="confirm-modal" class="modal"><div class="modal-content"><h2 id="confirm-modal-title">Megerősítés</h2><p id="confirm-modal-text"></p><div class="modal-buttons"><button id="btn-confirm-yes" class="btn-confirm">Igen</button><button id="btn-confirm-no" class="btn-cancel">Nem</button></div></div></div>

    <div id="svg-definitions" style="display: none;">
        <svg id="miss-svg" viewBox="0 0 100 100"><path d="M 20 50 Q 50 20 80 50 M 30 60 Q 50 40 70 60" stroke="#FFF" stroke-width="8" fill="none" /></svg>
        <svg id="hit-svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="25" fill="#FFF" /><circle cx="50" cy="50" r="15" fill="var(--hit-color)" /></svg>
        <svg id="points-svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12,2A3,3 0 0,0 9,5A3,3 0 0,0 12,8A3,3 0 0,0 15,5A3,3 0 0,0 12,2M19,13C19,14.09 18.6,15.12 18,16H13V14H18C18,13.67 18.1,13.34 18.25,13.05L17,11.83C16.36,12.54 15.5,13 14.5,13H10.5C9.5,13 8.64,12.54 8,11.83L6.75,13.05C6.9,13.34 7,13.67 7,14H5A3,3 0 0,0 2,17A3,3 0 0,0 5,20H19A3,3 0 0,0 22,17A3,3 0 0,0 19,14V13Z" /></svg>
        <svg id="mine-svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C10.68 2 9.4 2.84 8.8 4H5V6H7.08C6.93 6.32 6.8 6.66 6.7 7H4V9H6.08C5.46 10.59 5.46 12.41 6.08 14H4V16H6.7C6.8 16.34 6.93 16.68 7.08 17H5V19H8.8C9.4 20.16 10.68 21 12 21S14.6 20.16 15.2 19H19V17H16.92C17.07 16.68 17.2 16.34 17.3 16H20V14H17.92C18.54 12.41 18.54 10.59 17.92 9H20V7H17.3C17.2 6.66 17.07 6.32 16.92 6H19V4H15.2C14.6 2.84 13.32 2 12 2M12 4A2 2 0 0 1 14 6A2 2 0 0 1 12 8A2 2 0 0 1 10 6A2 2 0 0 1 12 4Z"/></svg>
        <svg id="intel-svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4Z"/></svg>
        <svg id="ammo-svg" viewBox="0 0 24 24"><path fill="currentColor" d="M7,2V4H8V18H7V22H9V21H11V20H13V19H14V18H15V17H16V4H17V2M9,4V16H10V15H11V14H12V5H11V4M13,6V13H14V12H15V5H13Z" /></svg>
        <svg id="sonar-svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12,3A9,9 0 0,0 3,12A9,9 0 0,0 12,21A9,9 0 0,0 21,12A9,9 0 0,0 12,3M5.24,8.21C6.2,6.4 7.9,5.03 9.9,4.42C9.28,5.92 9,7.44 9,9C9,10.56 9.28,12.08 9.9,13.58C7.9,12.97 6.2,11.6 5.24,9.79C5.07,9.47 5,9.14 5,8.79C5,8.59 5.03,8.4 5.08,8.21M17,15.25A12.76,12.76 0 0,1 14.1,19.58C13.04,18.04 12.39,16.32 12.39,14.5C12.39,11.68 13.5,9.17 15.34,7.42C16.36,8.66 17,10.22 17,12C17,13.16 16.64,14.26 16.04,15.25Z"/></svg>
        <svg id="strike-svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6M11,11V15H13V11H11M11,7V9H13V7H11Z"/></svg>
        <svg id="torpedo-svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12.01 1.5c-1.25 0-2.3.8-2.73 1.9H7.5c-.83 0-1.5.67-1.5 1.5v.5h-2c-1.1 0-2 .9-2 2v2c0 1.1.9 2 2 2h2v.5c0 .83.67 1.5 1.5 1.5h1.77c.43 1.1 1.48 1.9 2.73 1.9s2.3-.8 2.73-1.9h1.77c.83 0 1.5-.67 1.5-1.5v-5c0-.83-.67-1.5-1.5-1.5h-1.77c-.43-1.1-1.48-1.9-2.73-1.9zm-9.51 7V7c0-.55.45-1 1-1h2v4h-2c-.55 0-1-.45-1-1zm3.5-5.5h1.5v9h-1.5c-.28 0-.5-.22-.5-.5v-8c0-.28.22-.5.5-.5zm5.5 8c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm3.5-6.5h1.5v5h-1.5c-.28 0-.5-.22-.5-.5v-4c0-.28.22-.5.5-.5zm4.5 5.5v2c0 .55-.45 1-1 1h-2v-4h2c.55 0 1 .45 1 1zM4 19h16v2H4z"/></svg>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
    const boardSize = 10;
    const MAP_REFRESH_INTERVAL = 5 * 60 * 1000;
    const SHIP_ROSTER = [ { name: "Parancsnoki Hajó", id: 'command', shape: [{r:0,c:0},{r:0,c:1},{r:0,c:2},{r:0,c:3},{r:1,c:1},{r:1,c:2}] }, { name: "Nehéz Hordozó", id: 'heavycarrier', shape: [{r:0,c:0},{r:0,c:1},{r:1,c:0},{r:1,c:1},{r:2,c:0},{r:2,c:1}] }, { name: "Dreadnought", id: 'dreadnought', shape: [{r:0,c:1},{r:1,c:0},{r:1,c:1},{r:1,c:2},{r:1,c:3},{r:2,c:1}] }, { name: "Csillagromboló", id: 'stardestroyer', shape: [{r:0,c:0},{r:0,c:1},{r:0,c:2},{r:1,c:1},{r:2,c:1},{r:3,c:1}] }, { name: "Hordozó", id: 'carrier', shape: [{r:0,c:0},{r:1,c:0},{r:2,c:0},{r:2,c:1},{r:2,c:2}] }, { name: "Szuper-Csatahajó", id: 'superbattleship', shape: [{r:0,c:0},{r:0,c:1},{r:0,c:2},{r:0,c:3},{r:0,c:4}] }, { name: "Kriksz-kraksz", id: 'zigzag5', shape: [{r:0,c:0},{r:0,c:1},{r:1,c:1},{r:1,c:2},{r:2,c:2}] }, { name: "Központi Erőd", id: 'cross', shape: [{r:0,c:1},{r:1,c:0},{r:1,c:1},{r:1,c:2},{r:2,c:1}] }, { name: "Csatahajó", id: 'battleship', shape: [{r:0,c:1},{r:1,c:0},{r:1,c:1},{r:1,c:2}] }, { name: "Nehézcirkáló", id: 'heavycruiser', shape: [{r:0,c:0},{r:0,c:1},{r:0,c:2},{r:0,c:3}] }, { name: "L-alakú Romboló", id: 'l_destroyer', shape: [{r:0,c:0},{r:1,c:0},{r:2,c:0},{r:2,c:1}] }, { name: "T-alakú Romboló", id: 't_destroyer', shape: [{r:0,c:0},{r:0,c:1},{r:0,c:2},{r:1,c:1}] }, { name: "Kígyóhajó", id: 'snake', shape: [{r:0,c:0},{r:1,c:0},{r:1,c:1},{r:2,c:1}] }, { name: "Kettős Fregatt", id: 'dual_frigate', shape: [{r:0,c:0},{r:0,c:1},{r:1,c:2},{r:1,c:3}] }, { name: "Aszimmetrikus", id: 'asymmetric', shape: [{r:0,c:0},{r:1,c:0},{r:1,c:1},{r:2,c:1}] }, { name: "Kalapács", id: 'hammer', shape: [{r:0,c:0},{r:1,c:0},{r:2,c:0},{r:1,c:1}] }, { name: "Pók", id: 'spider', shape: [{r:0,c:1},{r:1,c:0},{r:1,c:2},{r:2,c:1}] }, { name: "H-hajó", id: 'h_ship', shape: [{r:0,c:0},{r:1,c:0},{r:2,c:0},{r:1,c:1},{r:0,c:2},{r:1,c:2},{r:2,c:2}] }, { name: "Nagy Kígyó", id: 'big_snake', shape: [{r:0,c:0},{r:1,c:0},{r:1,c:1},{r:2,c:1},{r:2,c:2},{r:3,c:2}] }, { name: "Cirkáló", id: 'cruiser', shape: [{r:0,c:0},{r:1,c:0},{r:2,c:0}] }, { name: "Tengeralattjáró", id: 'submarine', shape: [{r:0,c:0},{r:1,c:0},{r:1,c:1}] }, { name: "Fregatt", id: 'frigate', shape: [{r:0,c:0},{r:1,c:1},{r:2,c:2}] }, { name: "Sarokvédő", id: 'corner', shape: [{r:0,c:0},{r:0,c:1},{r:1,c:0}] }, { name: "Háromszög", id: 'tri', shape: [{r:0,c:1},{r:1,c:0},{r:1,c:2}] }, { name: "Villa", id: 'fork', shape: [{r:0,c:0},{r:0,c:2},{r:1,c:1}] }, { name: "Fél Kereszt", id: 'half_cross', shape: [{r:0,c:1},{r:1,c:0},{r:1,c:1}] }, { name: "C-hajó", id: 'c_ship', shape: [{r:0,c:0},{r:1,c:0},{r:2,c:0},{r:0,c:1},{r:2,c:1}] }, { name: "S-hajó", id: 's_ship', shape: [{r:0,c:1},{r:0,c:2},{r:1,c:1},{r:2,c:0},{r:2,c:1}] }, { name: "Romboló", id: 'destroyer', shape: [{r:0,c:0},{r:0,c:1}] }, { name: "Aknaszedő", id: 'minesweeper', shape: [{r:0,c:0},{r:1,c:1}] }, { name: "Járőrhajó", id: 'patrol', shape: [{r:0,c:0},{r:2,c:0}] }, { name: "Fürge Lopakodó", id: 'stealth', shape: [{r:0,c:0},{r:1,c:2}] }, { name: "Katamaran", id: 'catamaran', shape: [{r:0,c:0},{r:0,c:2},{r:1,c:0},{r:1,c:2}] }, { name: "Fegyverplatform", id: 'gun_platform', shape: [{r:0,c:0},{r:0,c:2},{r:1,c:1},{r:2,c:0},{r:2,c:2}] }, { name: "Lépcsős Romboló", id: 'stair_destroyer', shape: [{r:0,c:0},{r:1,c:1},{r:2,c:2},{r:3,c:3}] }, { name: "U-hajó", id: 'u_boat', shape: [{r:0,c:0},{r:1,c:0},{r:2,c:0},{r:2,c:1},{r:2,c:2},{r:1,c:2},{r:0,c:2}] }, { name: "Dupla L", id: 'double_l', shape: [{r:0,c:0},{r:1,c:0},{r:1,c:1}] }, { name: "Dárda", id: 'spear', shape: [{r:0,c:1},{r:1,c:0},{r:1,c:2},{r:2,c:1}] }, { name: "Blokád", id: 'blockade', shape: [{r:0,c:0},{r:0,c:1},{r:1,c:0},{r:1,c:1}] }, { name: "Hosszú Z", id: 'long_z', shape: [{r:0,c:0},{r:0,c:1},{r:1,c:1},{r:1,c:2}] }, { name: "Kompakt T", id: 'compact_t', shape: [{r:0,c:0},{r:0,c:1},{r:0,c:2},{r:1,c:1}] }, { name: "Csipesz", id: 'pincer', shape: [{r:0,c:0},{r:0,c:2},{r:1,c:1}] }, { name: "Szöglet", id: 'angle', shape: [{r:0,c:0},{r:1,c:0},{r:2,c:0},{r:2,c:1}] }, { name: "Oldalazó", id: 'sidewinder', shape: [{r:0,c:1},{r:1,c:0},{r:1,c:1},{r:2,c:0}] }, { name: "Dögcédula", id: 'dog_tag', shape: [{r:0,c:0},{r:0,c:1},{r:1,c:0}] }, { name: "Motorcsónak", id: 'speedboat', shape: [{r:0,c:0}] }, { name: "Felderítő drón", id: 'drone', shape: [{r:0,c:0}] } ];

    const DOM = {
        mainPanel: document.getElementById('main-panel'), sidePanel: document.getElementById('side-panel'),
        gameBoard: document.getElementById('game-board'), boardWrapper: document.getElementById('board-wrapper'), messageOverlay: document.getElementById('board-message-overlay'),
        shots: document.querySelector('#shots-stat p'), premium: document.querySelector('#premium-stat p'), premiumStat: document.getElementById('premium-stat'), shipsLeft: document.querySelector('#ships-left-stat p'),
        fleetStatus: document.getElementById('fleet-status'), fleetList: document.getElementById('fleet-list'), newGameBtn: document.getElementById('new-map-button'), waitingPanel: document.getElementById('waiting-panel'),
        waitingTime: document.getElementById('waiting-time'), nextRoundInfo: document.getElementById('next-round-info'), liveTimeWaiting: document.getElementById('live-time-waiting'),
        renameBtn: document.getElementById('rename-players-btn'), p1Info: document.getElementById('player1-info'), p2Info: document.getElementById('player2-info'),
        grandPrizeModal: document.getElementById('grand-prize-modal'), outOfAmmoModal: document.getElementById('out-of-ammo-modal'), summaryModal: document.getElementById('summary-modal'), rulesModal: document.getElementById('rules-modal'), confirmModal: document.getElementById('confirm-modal'),
        p1DailyScore: document.getElementById('p1-daily-score'), p2DailyScore: document.getElementById('p2-daily-score'), p1WeeklyWins: document.getElementById('p1-weekly-wins'), p2WeeklyWins: document.getElementById('p2-weekly-wins'), lastWeekChampion: document.getElementById('last-week-champion-name'),
        p1NameDaily: document.getElementById('p1-leaderboard-name-daily'), p2NameDaily: document.getElementById('p2-leaderboard-name-daily'), p1NameWeekly: document.getElementById('p1-leaderboard-name-weekly'), p2NameWeekly: document.getElementById('p2-leaderboard-name-weekly'),
        openRulesBtn: document.getElementById('open-rules-modal-btn'), closeRulesBtn: document.getElementById('btn-close-rules-modal'), btnAmmoEnd: document.getElementById('btn-ammo-end'), btnCloseSummary: document.getElementById('btn-close-summary-modal'),
        useSonarBtn: document.getElementById('use-sonar'), useStrikeBtn: document.getElementById('use-strike'), turnIndicatorBar: document.getElementById('turn-indicator-bar'), aidsContainer: document.getElementById('aids-container'),
        aidItemsStored: document.getElementById('aid-items-stored'), p1LeaderboardDaily: document.getElementById('p1-leaderboard-daily'), p2LeaderboardDaily: document.getElementById('p2-leaderboard-daily'),
        p1LeaderboardWeekly: document.getElementById('p1-leaderboard-weekly'), p2LeaderboardWeekly: document.getElementById('p2-leaderboard-weekly'),
        icons: { miss: document.getElementById('miss-svg'), hit: document.getElementById('hit-svg'), torpedo: document.getElementById('torpedo-svg'), points: document.getElementById('points-svg'), mine: document.getElementById('mine-svg'), intel: document.getElementById('intel-svg'), ammo: document.getElementById('ammo-svg'), sonar: document.getElementById('sonar-svg'), strike: document.getElementById('strike-svg') }
    };

    let boardState, ships, shots, premiumShots, gameOver, currentMapSeed, seededRandom, messageTimeout, minesFoundThisRound, roundModifier, foundSpecialLastTurn;
    let gameInProgress = false, sonarActive = false, strikeActive = false;
    let currentPlayer = 1, lockedPlayer = 0;
    let roundSonarCharges = 0, roundStrikeCharges = 0;
    let championshipState = { player1Name: "Játékos 1", player2Name: "Játékos 2", p1DailyScore: 0, p2DailyScore: 0, p1WeeklyWins: 0, p2WeeklyWins: 0,
        lastChampionCheck: new Date(0).toISOString(), currentWeekId: getWeekId(new Date()), lastWeeksChampion: "-", lastLoginDate: getDayId(new Date(0)),
        p1LastDayScore: 0, p2LastDayScore: 0, storedAids: { sonar: 0, strike: 0 }
    };

    const mulberry32 = (a) => () => { let t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; };

    function saveState() { localStorage.setItem('globalTorpedoChampionship', JSON.stringify(championshipState)); }
    function loadState() {
        const savedChampionship = localStorage.getItem('globalTorpedoChampionship');
        if (savedChampionship) { const loaded = JSON.parse(savedChampionship); championshipState = { ...championshipState, ...loaded }; }
        handleDailyReset(); renderLeaderboard(); renderLeaderboardNames(); renderStoredAids();
    }

    function getDayId(date) { const d = new Date(date); d.setHours(d.getHours()); return d.toISOString().slice(0, 10); }
    function getWeekId(date) { const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7); return d.getUTCFullYear() + '-W' + weekNo; }

    function handleDailyReset() {
        const now = new Date();
        const todayId = getDayId(now);
        const lastCheckId = getDayId(new Date(championshipState.lastChampionCheck));

        if (todayId !== lastCheckId) {
            let dailyWinnerName = "Döntetlen"; let dailyWinnerScore = championshipState.p1DailyScore;
            if (championshipState.p1DailyScore > championshipState.p2DailyScore) { championshipState.p1WeeklyWins++; dailyWinnerName = championshipState.player1Name; }
            else if (championshipState.p2DailyScore > championshipState.p1DailyScore) { championshipState.p2WeeklyWins++; dailyWinnerName = championshipState.player2Name; dailyWinnerScore = championshipState.p2DailyScore; }

            championshipState.p1LastDayScore = championshipState.p1DailyScore; championshipState.p2LastDayScore = championshipState.p2DailyScore;

            if (todayId !== championshipState.lastLoginDate) { showSummaryModal(dailyWinnerName, dailyWinnerScore); championshipState.lastLoginDate = todayId; }

            championshipState.p1DailyScore = 0; championshipState.p2DailyScore = 0;
            championshipState.storedAids = { sonar: 0, strike: 0 };
        }

        const currentWeekId = getWeekId(now);
        if (championshipState.currentWeekId !== currentWeekId) {
            let weeklyWinnerName = "-";
            if (championshipState.p1WeeklyWins > championshipState.p2WeeklyWins) weeklyWinnerName = championshipState.player1Name;
            else if (championshipState.p2WeeklyWins > championshipState.p1WeeklyWins) weeklyWinnerName = championshipState.player2Name;
            else if (championshipState.p1WeeklyWins > 0) weeklyWinnerName = "Döntetlen";
            championshipState.lastWeeksChampion = weeklyWinnerName;
            championshipState.p1WeeklyWins = 0; championshipState.p2WeeklyWins = 0; championshipState.currentWeekId = currentWeekId;
        }
        championshipState.lastChampionCheck = now.toISOString(); saveState();
    }

    function showSummaryModal(winner, score) {
        const contentEl = document.getElementById('summary-content');
        contentEl.innerHTML = `<h3>Tegnapi Nap Eredményei</h3><p><strong>A nap győztese:</strong> <span style="color: var(--premium-glow);">${winner}</span> (${score} pont)</p><p><strong>${championshipState.player1Name} pontjai:</strong> ${championshipState.p1LastDayScore}</p><p><strong>${championshipState.player2Name} pontjai:</strong> ${championshipState.p2LastDayScore}</p><hr style="border-color: var(--cell-border); margin: 15px 0;"><h3>Heti Bajnokság Állása</h3><p><strong>${championshipState.player1Name} győzelmei:</strong> ${championshipState.p1WeeklyWins}</p><p><strong>${championshipState.player2Name} győzelmei:</strong> ${championshipState.p2WeeklyWins}</p>`;
        DOM.summaryModal.classList.add('visible');
    }

    function initGame(forceNew = false) {
        if (gameOver && !forceNew) { startNewRound(true); return; }
        currentMapSeed = Math.floor(Date.now() / MAP_REFRESH_INTERVAL);
        seededRandom = mulberry32(currentMapSeed); shots = 60; premiumShots = 0; gameOver = false; gameInProgress = true;
        currentPlayer = 1; lockedPlayer = 0; minesFoundThisRound = 0; foundSpecialLastTurn = false;
        roundSonarCharges = 0; roundStrikeCharges = 0;

        boardState = Array(boardSize).fill(null).map(() => Array(boardSize).fill(null).map(() => ({ shipId: null, special: null, state: 'empty' })));
        const modRoll = seededRandom();
        if (modRoll < 0.15) { roundModifier = 'veteran_fleet'; }
        else if (modRoll < 0.30) { roundModifier = 'storm'; }
        else { roundModifier = 'normal'; }
        displayMessage("Kezdődjön a csata!", 3000, () => {
            if(roundModifier === 'veteran_fleet') displayMessage('VETERÁN FLOTTA!', 3000);
            if(roundModifier === 'storm') displayMessage('TENGERI VIHAR!', 3000);
        });
        DOM.newGameBtn.style.display = 'none'; DOM.waitingPanel.style.display = 'none'; DOM.turnIndicatorBar.style.display = 'block'; document.getElementById('main-panel').style.display = 'flex';
        const currentFleetTypes = selectRandomFleet(); placeShips(currentFleetTypes); placeSpecials();
        renderBoard(); renderFleetStatus(); updateStats(); updateArsenalUI(); renderStoredAids(); handleLayout();
        updatePlayerUI();
    }

    function startNewRound(force = false) { if (force) { initGame(true); } else { showConfirmationModal("Biztosan új portyára indulsz? A jelenlegi köröd elveszik.", () => initGame(true)); } }

    function selectRandomFleet() { const shuffledRoster = [...SHIP_ROSTER].sort(() => 0.5 - seededRandom()); const fleetSize = 7 + Math.floor(seededRandom() * 2); return shuffledRoster.slice(0, fleetSize); }
    function showWaitingScreen() { gameInProgress = false; DOM.turnIndicatorBar.style.display = 'none'; document.getElementById('main-panel').style.display = 'none'; DOM.newGameBtn.style.display = 'none'; DOM.waitingPanel.style.display = 'block'; updateStats(); handleLayout(); }
    function normalizeShape(shape) { const minR = Math.min(...shape.map(p => p.r)); const minC = Math.min(...shape.map(p => p.c)); return shape.map(p => ({ r: p.r - minR, c: p.c - minC })); }
    function getShapeTransformations(shape) { const transformations = new Set(); let currentShape = shape; for (let i = 0; i < 4; i++) { currentShape = normalizeShape(currentShape.map(p => ({ r: -p.c, c: p.r }))); transformations.add(JSON.stringify(currentShape.sort((a,b) => a.r - b.r || a.c - b.c))); } currentShape = normalizeShape(shape.map(p => ({ r: p.r, c: -p.c }))); for (let i = 0; i < 4; i++) { currentShape = normalizeShape(currentShape.map(p => ({ r: -p.c, c: p.r }))); transformations.add(JSON.stringify(currentShape.sort((a,b) => a.r - b.r || a.c - b.c))); } return Array.from(transformations, s => JSON.parse(s)); }
    function placeShips(fleetTypes) { ships = []; fleetTypes.forEach(shipType => { const allOrientations = getShapeTransformations(shipType.shape); let placed = false; let attempts = 0; while (!placed && attempts < 100) { attempts++; const orientation = allOrientations[Math.floor(seededRandom() * allOrientations.length)]; const shapeWidth = Math.max(...orientation.map(p => p.c)) + 1; const shapeHeight = Math.max(...orientation.map(p => p.r)) + 1; const sr = Math.floor(seededRandom() * (boardSize - shapeHeight + 1)); const sc = Math.floor(seededRandom() * (boardSize - shapeWidth + 1)); if (isValidPlacement(orientation, sr, sc)) { const coords = []; orientation.forEach(part => { const r = sr + part.r; const c = sc + part.c; boardState[r][c].shipId = shipType.id; coords.push({ row: r, col: c }); }); ships.push({ ...shipType, size: shipType.shape.length, coords, hits: 0, sunk: false, isVeteran: (roundModifier === 'veteran_fleet') }); placed = true; } } }); if (ships.length > 0 && roundModifier !== 'veteran_fleet') { const veteranIndex = Math.floor(seededRandom() * ships.length); ships[veteranIndex].isVeteran = true; } }
    function isValidPlacement(shape, startRow, startCol) { for (const part of shape) { const r = startRow + part.r; const c = startCol + part.c; if (r < 0 || r >= boardSize || c < 0 || c >= boardSize) return false; for (let dr = -1; dr <= 1; dr++) { for (let dc = -1; dc <= 1; dc++) { const checkR = r + dr; const checkC = c + dc; if (checkR >= 0 && checkR < boardSize && checkC >= 0 && checkC < boardSize) { if (boardState[checkR][checkC].shipId !== null) { return false; } } } } } return true; }
    function placeSpecials() { let specialTypes = [{type:'intel'}, {type:'ammo', value: 10}, {type:'ammo', value:20}, {type:'aid', kind:'sonar'}, {type:'aid', kind:'strike'}]; const numMines = roundModifier === 'storm' ? 5 : 3; for(let i=0; i<numMines; i++) specialTypes.push({type:'mine'}); const numPointTiles = seededRandom() > 0.3 ? Math.floor(seededRandom() * 3) + 1 : 0; for(let i=0; i<numPointTiles; i++) specialTypes.push({type:'points', value: seededRandom() > 0.5 ? 10 : 5}); specialTypes.forEach(special => { let placed = false; while (!placed) { const r = Math.floor(seededRandom() * boardSize); const c = Math.floor(seededRandom() * boardSize); if (boardState[r][c].shipId === null && boardState[r][c].special === null) { boardState[r][c].special = special; placed = true; } } }); }

    function renderBoard() {
        DOM.gameBoard.innerHTML = '';
        const headerRow = DOM.gameBoard.insertRow();
        headerRow.innerHTML = `<th></th>${Array.from({length: boardSize}, (_, i) => `<th>${String.fromCharCode(65 + i)}</th>`).join('')}`;
        for (let i = 0; i < boardSize; i++) {
            const rowEl = DOM.gameBoard.insertRow();
            const th = document.createElement('th');
            th.textContent = i + 1;
            rowEl.appendChild(th);
            for (let j = 0; j < boardSize; j++) {
                const cellEl = rowEl.insertCell();
                cellEl.dataset.row = i;
                cellEl.dataset.col = j;
                cellEl.addEventListener('click', handleCellClick);
            }
        }
    }
    function renderFleetStatus() { if(!ships) return; DOM.fleetList.innerHTML = ships.sort((a,b) => b.size - a.size).map(ship => `<li id="fleet-${ship.id}" class="${ship.sunk ? 'sunk' : ''} ${ship.hits > 0 && !ship.sunk ? 'found' : ''}"><div>${ship.isVeteran ? '<span class="veteran-star">★ </span>' : ''}${ship.name} (${ship.size})</div></li>`).join(''); }
    function renderLeaderboard() { DOM.p1DailyScore.textContent = championshipState.p1DailyScore; DOM.p2DailyScore.textContent = championshipState.p2DailyScore; DOM.p1WeeklyWins.textContent = championshipState.p1WeeklyWins; DOM.p2WeeklyWins.textContent = championshipState.p2WeeklyWins; DOM.lastWeekChampion.textContent = championshipState.lastWeeksChampion; }
    function renderLeaderboardNames() { DOM.p1NameDaily.textContent = championshipState.player1Name; DOM.p2NameDaily.textContent = championshipState.player2Name; DOM.p1NameWeekly.textContent = championshipState.player1Name; DOM.p2NameWeekly.textContent = championshipState.player2Name; }

    function handleCellClick(e) {
        if (gameOver || !gameInProgress) return;
        const targetCell = e.target.closest('td');
        if (!targetCell) return;
        if (sonarActive) { executeSonar(parseInt(targetCell.dataset.row), parseInt(targetCell.dataset.col)); return; }
        if (strikeActive) { executeStrike(parseInt(targetCell.dataset.row), parseInt(targetCell.dataset.col)); return; }
        if (lockedPlayer !== 0 && lockedPlayer !== currentPlayer) return;
        if (boardState[targetCell.dataset.row][targetCell.dataset.col].state !== 'empty') return;
        if (shots <= 0 && premiumShots <= 0) { DOM.outOfAmmoModal.classList.add('visible'); return; }

        const isPremiumShot = premiumShots > 0;
        if (isPremiumShot) { premiumShots--; } else { shots--; }
        targetCell.classList.add('shot');

        const cellState = boardState[targetCell.dataset.row][targetCell.dataset.col];
        if (cellState.shipId) { handleHit(targetCell); }
        else {
            foundSpecialLastTurn = false;
            if (cellState.special) { handleSpecial(targetCell, cellState.special); }
            else { handleMiss(targetCell); }
        }
        updateStats(); checkGameOver();
    }

    function handleHit(cellEl) {
        const row = parseInt(cellEl.dataset.row), col = parseInt(cellEl.dataset.col);
        const hitShip = ships.find(ship => ship.id === boardState[row][col].shipId);
        if (!hitShip || boardState[row][col].state === 'hit') return;

        boardState[row][col].state = 'hit';
        cellEl.classList.add('hit'); cellEl.appendChild(DOM.icons.hit.cloneNode(true)).classList.add('icon');
        if (hitShip.hits === 0 && !hitShip.sunk) document.getElementById(`fleet-${hitShip.id}`).classList.add('found');
        hitShip.hits++;

        let bonusMessage = "";
        if (foundSpecialLastTurn) {
            const bonusPoints = 2;
            if (currentPlayer === 1) { championshipState.p1DailyScore += bonusPoints; } else { championshipState.p2DailyScore += bonusPoints; }
            renderLeaderboard(); bonusMessage = `<br>Szerencsevadász: +${bonusPoints} Pont!`;
        }
        if (seededRandom() < 0.1) { premiumShots += 2; bonusMessage += `<br>Kritikus Találat: +2 Prémium!`; }
        premiumShots++;

        displayMessage(`TALÁLAT!${bonusMessage}`, 2000, () => { if (premiumShots > 0) displayMessage("PRÉMIUM LÖVÉS!", 1500); });

        if (hitShip.hits === hitShip.size) handleSunkShip(hitShip);
        foundSpecialLastTurn = false;
    }

    // ================== JAVÍTOTT FUNKCIÓ ==================
    function handleSunkShip(sunkShip) {
        sunkShip.sunk = true;
        premiumShots++; // HIBAJAVÍTÁS: Prémium lövés hozzáadása a süllyesztésért a szabályzatnak megfelelően.

        let pointsAwarded = 1 + sunkShip.size;
        if(sunkShip.isVeteran) pointsAwarded *= 2;

        if (currentPlayer === 1) { championshipState.p1DailyScore += pointsAwarded; } else { championshipState.p2DailyScore += pointsAwarded; }
        renderLeaderboard();

        // Üzenet megjelenítése a pontokról, majd utána a jutalom lövésről.
        displayMessage(`${sunkShip.isVeteran ? 'VETERÁN ' : ''}${sunkShip.name} elsüllyedt!<br>+${pointsAwarded} pont`, 3000, () => {
            displayMessage("JUTALOM LÖVÉS!", 1500);
        });

        sunkShip.coords.forEach(({ row, col }) => {
            DOM.gameBoard.querySelector(`[data-row='${row}'][data-col='${col}']`).classList.add('sunk');
        });

        renderFleetStatus(); // A flotta teljes listáját újra kirajzolja a frissített 'sunk' állapot alapján.
    }
    // =======================================================


    function handleSpecial(cellEl, special) {
        boardState[cellEl.dataset.row][cellEl.dataset.col].state = 'special';
        let givesExtraTurn = false;
        switch (special.type) {
            case 'mine':
                cellEl.classList.add('mine'); cellEl.appendChild(DOM.icons.mine.cloneNode(true)).classList.add('icon');
                premiumShots = 0; minesFoundThisRound++;
                let penaltyPoints = [3, 4, 5][minesFoundThisRound - 1] || 5;
                if (currentPlayer === 1) { championshipState.p1DailyScore -= penaltyPoints; } else { championshipState.p2DailyScore -= penaltyPoints; }
                renderLeaderboard(); displayMessage(`BUMM! ${minesFoundThisRound}. Akna!<br>-${penaltyPoints} pont`, 2500);
                switchPlayer(); break;
            case 'intel':
                cellEl.classList.add('intel'); cellEl.appendChild(DOM.icons.intel.cloneNode(true)).classList.add('icon');
                displayMessage("JELZÉS ELFOGVA!", 2000, () => revealIntel()); switchPlayer(); break;
            case 'points':
                cellEl.classList.add('points'); cellEl.appendChild(DOM.icons.points.cloneNode(true)).classList.add('icon');
                if (currentPlayer === 1) { championshipState.p1DailyScore += special.value; } else { championshipState.p2DailyScore += special.value; }
                renderLeaderboard(); displayMessage(`Bónusz pont!<br>+${special.value}`, 2000); givesExtraTurn = true; break;
            case 'ammo':
                cellEl.classList.add('ammo'); cellEl.appendChild(DOM.icons.ammo.cloneNode(true)).classList.add('icon');
                shots += special.value; displayMessage(`Lőszer!<br>+${special.value}`, 2000); givesExtraTurn = true; break;
            case 'aid':
                cellEl.classList.add('aid');
                if(special.kind === 'sonar') { roundSonarCharges++; cellEl.appendChild(DOM.icons.sonar.cloneNode(true)).classList.add('icon'); displayMessage(`Szónár a fedélzeten!`, 2000); }
                else { roundStrikeCharges++; cellEl.appendChild(DOM.icons.strike.cloneNode(true)).classList.add('icon'); displayMessage(`Célzott Csapás elérhető!`, 2000); }
                updateArsenalUI(); givesExtraTurn = true; break;
        }
        if (givesExtraTurn) { foundSpecialLastTurn = true; premiumShots++; displayMessage("Jutalmul újra lőhetsz!", 1500); }
    }
    function revealIntel() { let revealed = false; let attempts = 0; while (!revealed && attempts < 20) { attempts++; if (seededRandom() > 0.5) { const r = Math.floor(seededRandom() * boardSize); if (!boardState[r].some(cell => cell.shipId !== null)) { for(let c=0; c<boardSize; c++) DOM.gameBoard.querySelector(`[data-row='${r}'][data-col='${c}']`).classList.add('intel-reveal-row'); displayMessage(`A(z) ${r+1}. sor tiszta!`, 2500); revealed = true; } } else { const c = Math.floor(seededRandom() * boardSize); let hasShip = false; for(let r=0; r<boardSize; r++) { if(boardState[r][c].shipId !== null) { hasShip = true; break; } } if (!hasShip) { for(let r=0; r<boardSize; r++) DOM.gameBoard.querySelector(`[data-row='${r}'][data-col='${c}']`).classList.add('intel-reveal-col'); displayMessage(`A(z) ${String.fromCharCode(65+c)} oszlop tiszta!`, 2500); revealed = true; } } } if (!revealed) displayMessage("A jel gyenge volt...", 2000); }
    function handleMiss(cellEl) { cellEl.classList.add('miss'); cellEl.appendChild(DOM.icons.miss.cloneNode(true)).classList.add('icon'); displayMessage("MELLÉ!", 1500); switchPlayer(); }

    function useAid(type, source) {
        if (sonarActive || strikeActive) return;
        let canUse = false;
        if (source === 'round') {
            if (type === 'sonar' && roundSonarCharges > 0) { roundSonarCharges--; canUse = true; updateArsenalUI(); }
            else if (type === 'strike' && roundStrikeCharges > 0) { roundStrikeCharges--; canUse = true; updateArsenalUI(); }
        } else if (source === 'stored') {
            if (type === 'sonar' && championshipState.storedAids.sonar > 0) { championshipState.storedAids.sonar--; canUse = true; renderStoredAids(); }
            else if (type === 'strike' && championshipState.storedAids.strike > 0) { championshipState.storedAids.strike--; canUse = true; renderStoredAids(); }
        }
        if (canUse) {
            if (type === 'sonar') { sonarActive = true; DOM.boardWrapper.classList.add('sonar-active'); displayMessage("Válassz egy középpontot a szónárnak!", 3000); }
            if (type === 'strike') { strikeActive = true; DOM.boardWrapper.classList.add('strike-active'); displayMessage("Válassz egy célpontot a csapásnak!", 3000); }
        }
    }

    function executeSonar(row, col) { sonarActive = false; DOM.boardWrapper.classList.remove('sonar-active'); for (let r = row - 1; r <= row + 1; r++) { for (let c = col - 1; c <= col + 1; c++) { if (r >= 0 && r < boardSize && c >= 0 && c < boardSize) { const cell = DOM.gameBoard.querySelector(`[data-row='${r}'][data-col='${c}']`); if (boardState[r][c].shipId && boardState[r][c].state === 'empty') { cell.classList.add('sonar-reveal'); }}}} switchPlayer(); }
    function executeStrike(row, col) { strikeActive = false; DOM.boardWrapper.classList.remove('strike-active'); const targetCell = DOM.gameBoard.querySelector(`[data-row='${row}'][data-col='${col}']`); if (boardState[row][col].state === 'empty') { premiumShots++; handleCellClick({ target: targetCell }); } else { switchPlayer(); } }

    function checkGameOver() { if (!gameOver && ships.every(ship => ship.sunk)) { gameOver = true; premiumShots = 0; updateStats(); saveState(); renderLeaderboard(); const message = `Minden hajó elsüllyedt!<br>Következik a Fődíj Játék!`; displayMessage(message, 4000, () => startGrandPrizeGame()); } }

    function startGrandPrizeGame() {
        let grandPrizeTurn = 1; let firstResultText = "";
        const container = document.getElementById('grand-prize-ships'); container.innerHTML = '';
        for (let i = 0; i < 15; i++) { container.innerHTML += `<button class="ship-choice" data-index="${i}"><div class="flipper"><div class="front"><svg viewBox="0 0 24 24"><use href="#torpedo-svg"></use></svg></div><div class="back"></div></div></button>`; }

        const statusEl = document.getElementById('grand-prize-status');
        const updateStatus = () => { statusEl.textContent = `${championshipState[`player${grandPrizeTurn}Name`]} választ!`; };
        updateStatus();
        const shipChoices = document.querySelectorAll('.ship-choice'); const closeBtn = document.getElementById('btn-close-grand-prize'); document.getElementById('grand-prize-result').innerHTML = ""; closeBtn.style.display = 'none';

        const prizePool = [ { type: 'points_double', label: 'NAPI PONT DUPLÁZÓ', cat: 'jackpot' }, { type: 'score_swap', label: 'PONTCSERE!', cat: 'jackpot' }, { type: 'points_add', value: 25, label: '+25 Pont', cat: 'good' }, { type: 'points_add', value: 15, label: '+15 Pont', cat: 'good' }, { type: 'points_add', value: 10, label: '+10 Pont', cat: 'good' }, { type: 'aid_add', kind: 'sonar', label: '+1 Szónár', cat: 'good' }, { type: 'aid_add', kind: 'strike', label: '+1 Célzott Csapás', cat: 'good' }, { type: 'points_halve', label: 'NAPI PONT FELEZŐ', cat: 'bad' }, { type: 'points_subtract', value: 15, label: '-15 Pont', cat: 'bad' }, { type: 'points_subtract', value: 10, label: '-10 Pont', cat: 'bad' }, { type: 'points_subtract', value: 5, label: '-5 Pont', cat: 'bad' }, { type: 'points_add', value: 5, label: '+5 Pont', cat: 'neutral' }, { type: 'aid_add', kind: 'sonar', label: '+1 Szónár', cat: 'neutral' }, { type: 'aid_add', kind: 'strike', label: '+1 Célzott Csapás', cat: 'neutral' } ];
        for (let i = prizePool.length - 1; i > 0; i--) { const j = Math.floor(seededRandom() * (i + 1)); [prizePool[i], prizePool[j]] = [prizePool[j], prizePool[i]]; }

        const revealChoice = (choiceIndex, playerNum) => {
            let resultText = ""; const result = prizePool[choiceIndex];
            if (result.type.includes('points') || result.type === 'score_swap') {
                const activePlayer = `p${playerNum}DailyScore`;
                if (result.type === 'points_add') { championshipState[activePlayer] += result.value; resultText = `+${result.value} napi pont!`; }
                else if (result.type === 'points_subtract') { championshipState[activePlayer] -= result.value; resultText = `-${result.value} napi pont!`; }
                else if (result.type === 'points_double') { championshipState[activePlayer] *= 2; resultText = `Mai pontok megduplázva!`; }
                else if (result.type === 'points_halve') { championshipState[activePlayer] = Math.floor(championshipState[activePlayer] / 2); resultText = `Mai pontok megfelezve!`; }
                else if (result.type === 'score_swap') { [championshipState.p1DailyScore, championshipState.p2DailyScore] = [championshipState.p2DailyScore, championshipState.p1DailyScore]; resultText = `Pontcsere a játékosok között!`; }
            } else if (result.type === 'aid_add') {
                championshipState.storedAids[result.kind]++; resultText = `+1 ${result.kind === 'sonar' ? 'Szónár' : 'Célzott Csapás'}!`;
            }
            return `${championshipState[`player${playerNum}Name`]}: ${resultText}`;
        };

        const choiceHandler = (e) => {
            const btn = e.currentTarget; if(btn.disabled) return;
            const choiceIndex = parseInt(btn.dataset.index);
            const back = btn.querySelector('.back'); const prize = prizePool[choiceIndex]; back.className = `back ${prize.cat}`; back.textContent = prize.label;
            btn.classList.add('is-flipped'); btn.disabled = true;

            if (grandPrizeTurn === 1) { firstResultText = revealChoice(choiceIndex, 1); document.getElementById('grand-prize-result').textContent = firstResultText; grandPrizeTurn = 2; setTimeout(updateStatus, 1500); shipChoices.forEach(b => b.disabled = b.classList.contains('is-flipped')); }
            else {
                const secondResultText = revealChoice(choiceIndex, 2); document.getElementById('grand-prize-result').textContent = `${firstResultText} | ${secondResultText}`;
                shipChoices.forEach(b => b.disabled = true);
                let delay = 500; shipChoices.forEach((ship, index) => { if(ship.classList.contains('is-flipped')) return; setTimeout(() => { const back = ship.querySelector('.back'); const prize = prizePool[index]; back.className = `back ${prize.cat}`; back.textContent = prize.label; ship.classList.add('is-flipped'); }, delay); delay += 100; });
                setTimeout(() => { closeBtn.style.display = 'block'; renderLeaderboard(); renderStoredAids(); saveState(); }, delay + 2000);
            }
        };

        shipChoices.forEach(btn => btn.addEventListener('click', choiceHandler));
        closeBtn.onclick = () => { DOM.grandPrizeModal.classList.remove('visible'); initGame(true); };
        DOM.grandPrizeModal.classList.add('visible');
    }

    function renderStoredAids() {
        const { sonar, strike } = championshipState.storedAids;
        DOM.aidItemsStored.innerHTML = '';
        if (sonar > 0) DOM.aidItemsStored.innerHTML += `<button id="use-stored-sonar"><span>Szónár Bevetése</span> <span class="aid-count">${sonar}</span></button>`;
        if (strike > 0) DOM.aidItemsStored.innerHTML += `<button id="use-stored-strike"><span>Célzott Csapás</span> <span class="aid-count">${strike}</span></button>`;

        if (sonar > 0) document.getElementById('use-stored-sonar').addEventListener('click', () => useAid('sonar', 'stored'));
        if (strike > 0) document.getElementById('use-stored-strike').addEventListener('click', () => useAid('strike', 'stored'));

        DOM.aidsContainer.style.display = (sonar > 0 || strike > 0) ? 'block' : 'none';
    }

    function switchPlayer() { if (premiumShots > 0) { displayMessage("PRÉMIUM LÖVÉS!", 1500); return; } currentPlayer = (currentPlayer === 1) ? 2 : 1; updatePlayerUI(); }

    function updatePlayerUI() {
        DOM.p1Info.innerHTML = `${championshipState.player1Name} <span class="lock-icon"></span>`;
        DOM.p2Info.innerHTML = `${championshipState.player2Name} <span class="lock-icon"></span>`;
        DOM.p1Info.classList.toggle('active', currentPlayer === 1);
        DOM.p2Info.classList.toggle('active', currentPlayer === 2);
        DOM.turnIndicatorBar.textContent = `${championshipState[`player${currentPlayer}Name`]} következik...`;
        DOM.p1LeaderboardDaily.classList.toggle('active-player-highlight', currentPlayer === 1);
        DOM.p1LeaderboardWeekly.classList.toggle('active-player-highlight', currentPlayer === 1);
        DOM.p2LeaderboardDaily.classList.toggle('active-player-highlight', currentPlayer === 2);
        DOM.p2LeaderboardWeekly.classList.toggle('active-player-highlight', currentPlayer === 2);
        renderLeaderboardNames();
        updateLockUI();
    }

    function togglePlayerLock(playerNum) { lockedPlayer = (lockedPlayer === playerNum) ? 0 : playerNum; updateLockUI(); }
    function updateLockUI() { DOM.p1Info.classList.remove('locked'); DOM.p2Info.classList.remove('locked'); document.querySelector('#player1-info .lock-icon').textContent = ''; document.querySelector('#player2-info .lock-icon').textContent = ''; DOM.boardWrapper.classList.remove('board-locked'); DOM.renameBtn.textContent = "Nevek Módosítása"; if (lockedPlayer === 1) { DOM.p1Info.classList.add('locked'); document.querySelector('#player1-info .lock-icon').textContent = '🔒'; DOM.renameBtn.textContent = "Vezérlés Feloldása"; } else if (lockedPlayer === 2) { DOM.p2Info.classList.add('locked'); document.querySelector('#player2-info .lock-icon').textContent = '🔒'; DOM.renameBtn.textContent = "Vezérlés Feloldása"; } if (lockedPlayer !== 0 && lockedPlayer !== currentPlayer) { DOM.boardWrapper.classList.add('board-locked'); } }
    function updateStats() { const shipsRemaining = ships ? ships.filter(s => !s.sunk).length : 0; const shipsTotal = ships ? ships.length : 0; DOM.shots.textContent = shots; DOM.premium.textContent = premiumShots; DOM.shipsLeft.textContent = `${shipsRemaining}/${shipsTotal}`; DOM.premiumStat.classList.toggle('active', premiumShots > 0 && !gameOver); }
    function updateArsenalUI() { DOM.useSonarBtn.textContent = `Szónár Bevetése (${roundSonarCharges})`; DOM.useSonarBtn.disabled = roundSonarCharges <= 0; DOM.useStrikeBtn.textContent = `Célzott Csapás (${roundStrikeCharges})`; DOM.useStrikeBtn.disabled = roundStrikeCharges <= 0; }
    function displayMessage(text, duration = 2000, callback) { clearTimeout(messageTimeout); const overlay = DOM.messageOverlay; overlay.innerHTML = text; overlay.style.animation = 'none'; overlay.offsetHeight; overlay.style.animation = `fade-in-out-zoom ${duration / 1000}s ease-in-out forwards`; messageTimeout = setTimeout(() => { if (callback) callback(); }, duration); }

    function handleLayout() {
        const isMobile = window.innerWidth <= 900;
        const fleetStatus = document.getElementById('fleet-status');
        const aidsContainer = document.getElementById('aids-container');
        if (isMobile) {
            if (fleetStatus.parentElement !== DOM.mainPanel) {
                DOM.mainPanel.insertBefore(fleetStatus, aidsContainer);
            }
        } else {
            if (fleetStatus.parentElement !== DOM.sidePanel) {
                DOM.sidePanel.insertBefore(fleetStatus, DOM.newGameBtn);
            }
        }
    }

    function showConfirmationModal(text, onConfirm) {
        document.getElementById('confirm-modal-text').textContent = text;
        DOM.confirmModal.classList.add('visible');
        const confirmYes = document.getElementById('btn-confirm-yes');
        const confirmNo = document.getElementById('btn-confirm-no');
        const yesHandler = () => { cleanup(); onConfirm(); };
        const noHandler = () => { cleanup(); };
        const cleanup = () => { DOM.confirmModal.classList.remove('visible'); confirmYes.removeEventListener('click', yesHandler); confirmNo.removeEventListener('click', noHandler); };
        confirmYes.addEventListener('click', yesHandler);
        confirmNo.addEventListener('click', noHandler);
    }

    function tick() {
        const now = new Date(); const millis = now.getTime();
        DOM.liveTimeWaiting.textContent = now.toLocaleTimeString('hu-HU');
        const nextMapTimestamp = (Math.floor(millis / MAP_REFRESH_INTERVAL) + 1) * MAP_REFRESH_INTERVAL;
        const nextMapDate = new Date(nextMapTimestamp);
        DOM.waitingTime.textContent = nextMapDate.toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' });

        const newSeed = Math.floor(millis / MAP_REFRESH_INTERVAL);
        if (newSeed > currentMapSeed) {
            if (gameInProgress) {
                DOM.newGameBtn.style.display = 'block';
            } else {
                initGame(true);
            }
        }
    }

    DOM.openRulesBtn.addEventListener('click', () => DOM.rulesModal.classList.add('visible'));
    DOM.closeRulesBtn.addEventListener('click', () => DOM.rulesModal.classList.remove('visible'));
    DOM.btnCloseSummary.addEventListener('click', () => DOM.summaryModal.classList.remove('visible'));
    DOM.renameBtn.addEventListener('click', () => {
        if (lockedPlayer !== 0) { togglePlayerLock(0); return; }
        const newP1 = prompt("Add meg az 1. Játékos nevét:", championshipState.player1Name);
        if (newP1 && newP1.trim() !== "") { championshipState.player1Name = newP1.trim(); }
        const newP2 = prompt("Add meg a 2. Játékos nevét:", championshipState.player2Name);
        if (newP2 && newP2.trim() !== "") { championshipState.player2Name = newP2.trim(); }
        updatePlayerUI();
        saveState();
    });
    DOM.p1Info.addEventListener('click', () => togglePlayerLock(1));
    DOM.p2Info.addEventListener('click', () => togglePlayerLock(2));
    DOM.newGameBtn.addEventListener('click', () => startNewRound(false));
    window.addEventListener('beforeunload', saveState);
    DOM.btnAmmoEnd.addEventListener('click', () => { DOM.outOfAmmoModal.classList.remove('visible'); initGame(true); });
    DOM.useSonarBtn.addEventListener('click', () => useAid('sonar', 'round'));
    DOM.useStrikeBtn.addEventListener('click', () => useAid('strike', 'round'));
    window.addEventListener('resize', handleLayout);

    loadState();
    setInterval(tick, 1000);
    initGame();
    handleLayout();
});
</script>
</body>
</html>
