<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Globális Torpedó</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@800&family=Poppins:wght@400;600&display=swap');

        :root {
            --cell-bg: rgba(255, 255, 255, 0.05); 
            --cell-border: #8e9eab;
            --text-color: #E0E5EC; --hit-color: #ff4757; --miss-color: #537895;
            --sunk-color: #343a40; --prize-color: #feca57; --premium-glow: #ffd700;
        }

        body {
            font-family: 'Poppins', sans-serif; display: flex; align-items: center; justify-content: center;
            min-height: 100vh; color: var(--text-color); margin: 0; padding: 20px; box-sizing: border-box;
            background-image: linear-gradient(to bottom, rgba(9, 20, 27, 0.85), rgba(15, 32, 39, 0.9)), url('https://images.pexels.com/photos/220201/pexels-photo-220201.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
            background-size: cover; background-position: center center; background-attachment: fixed; background-repeat: no-repeat;
        }

        #game-container {
            width: 100%; max-width: 950px; background: rgba(0, 0, 0, 0.3);
            padding: clamp(20px, 4vw, 40px); border-radius: 30px; backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 0 50px rgba(0,0,0,0.5);
            display: flex; flex-wrap: wrap; gap: 30px; justify-content: center;
        }

        #main-panel { flex-grow: 1; min-width: 320px; }
        #side-panel { width: 250px; flex-shrink: 0; display: flex; flex-direction: column; gap: 20px;}

        #game-header { text-align: center; margin-bottom: 20px; }
        #game-header h1 {
            font-family: 'Orbitron', sans-serif; font-size: clamp(2.5rem, 8vw, 4rem); color: white;
            margin: 0; text-shadow: 0 0 10px var(--cell-border), 0 0 20px var(--cell-border);
        }

        #message-container { height: 30px; margin-bottom: 15px; font-size: 1.2em; font-weight: 600; text-align: center; color: var(--premium-glow); text-transform: uppercase; }
        
        #stats-panel { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; text-align: center; }
        .stat { background: var(--cell-bg); padding: 10px; border-radius: 12px; border: 1px solid var(--cell-border); }
        .stat h3 { margin: 0 0 5px 0; font-size: 0.8em; color: var(--cell-border); text-transform: uppercase; }
        .stat p { margin: 0; font-size: 1.4em; font-weight: 600; }
        #premium-stat.active p { color: var(--premium-glow); animation: pulse 1.5s infinite; }

        #game-board { border-collapse: separate; border-spacing: 4px; margin: 0 auto; }
        #game-board th, #game-board td { width: clamp(28px, 6.5vw, 40px); height: clamp(28px, 6.5vw, 40px); text-align: center; font-family: 'Orbitron'; color: var(--cell-border); vertical-align: middle; user-select: none; }
        #game-board th { background: rgba(255, 255, 255, 0.03); border-radius: 8px; }
        #game-board td { background: var(--cell-bg); border: 2px solid var(--cell-border); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative; }
        #game-board td:hover:not(.shot) { background-color: rgba(142, 158, 171, 0.3); transform: scale(1.05); }
        #game-board td.shot { cursor: not-allowed; } #game-board td.shot:hover { transform: none; }
        #game-board td.miss { background-color: var(--miss-color); }
        #game-board td.hit { background-color: var(--hit-color); animation: hit-shake 0.5s; }
        #game-board td.sunk { animation: sink-animation 1s forwards; }
        #game-board td.prize { background-color: var(--prize-color); border-color: #FFF; box-shadow: 0 0 15px var(--prize-color); }
        
        #waiting-panel { display: none; text-align: center; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 20px; }
        #waiting-title { font-family: 'Orbitron'; font-size: 2em; color: var(--premium-glow); margin-bottom: 10px; }
        #waiting-info { font-family: 'Poppins'; font-size: 1.2em; margin: 15px 0; color: white; }
        #waiting-time, #waiting-score { font-family: 'Orbitron'; font-size: 1.5em; color: var(--premium-glow); }
        #rules-container { text-align: left; font-size: 0.9em; padding: 15px; border-top: 1px solid var(--cell-border); margin-top: 15px; }
        #rules-container h3 { color: var(--premium-glow); border-bottom: 1px solid var(--premium-glow); padding-bottom: 5px; margin-top: 0; }
        #rules-container ul { padding-left: 20px; margin: 10px 0 0 0; }
        #rules-container li { margin-bottom: 8px; }

        .icon { width: 70%; height: 70%; vertical-align: middle; position: absolute; top: 15%; left: 15%; }
        
        .side-box { background: rgba(0,0,0,0.2); border-radius: 15px; padding: 15px; }
        .side-box h2 { font-family: 'Orbitron'; text-align: center; color: var(--cell-border); border-bottom: 2px solid var(--cell-border); padding-bottom: 5px; margin-top: 0; font-size: 1.2em; }
        #fleet-list, #prize-list { list-style: none; padding: 0; margin: 0; }
        #fleet-list li, #prize-list li { background: var(--cell-bg); padding: 8px; border-radius: 8px; margin-bottom: 8px; font-weight: 600; transition: all 0.3s; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
        #fleet-list li.sunk { background-color: var(--sunk-color); opacity: 0.6; text-decoration: line-through; }
        
        #time-info p { margin: 5px 0; text-align: center; font-weight: bold; }
        #time-info #current-time { font-size: 1.5em; color: white; }
        #new-map-button { display: none; width: 100%; margin-top: 15px; padding: 12px; font-size: 1em; font-weight: 700; font-family: 'Orbitron'; color: #000; background-color: var(--premium-glow); border: none; border-radius: 15px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 0 20px var(--premium-glow); }
        #new-map-button:hover { transform: scale(1.05); }
        
        #shop-items button, .sell-prize-btn { padding: 10px; margin-bottom: 8px; background-color: var(--cell-bg); border: 1px solid var(--cell-border); color: var(--text-color); border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .shop-item { position: relative; margin-bottom: 8px; }
        .shop-item button { width: 100%; margin: 0; }
        .item-badge { position: absolute; top: -5px; right: -5px; background-color: var(--premium-glow); color: #000; border-radius: 50%; width: 22px; height: 22px; line-height: 22px; text-align: center; font-weight: bold; font-size: 0.9em; box-shadow: 0 0 10px var(--premium-glow); }
        .sell-prize-btn { font-size: 0.8em; padding: 4px 8px; margin: 0; background-color: var(--premium-glow); color: #000; font-weight: bold; }
        #shop-items button:hover:not(:disabled), .sell-prize-btn:hover { background-color: rgba(142, 158, 171, 0.4); }
        #shop-items button:disabled { cursor: not-allowed; opacity: 0.5; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content { background: linear-gradient(145deg, #232526, #414345); border: 2px solid var(--premium-glow); border-radius: 20px; padding: 30px; text-align: center; color: white; width: 90%; max-width: 650px; transform: scale(0.9); transition: transform 0.3s; box-shadow: 0 0 30px var(--premium-glow); }
        .modal.visible .modal-content { transform: scale(1); }
        .modal-content h2 { font-family: 'Orbitron'; margin-top: 0; font-size: 2.2em; text-shadow: 0 0 10px var(--premium-glow); } 
        .modal-content p { font-size: 1.1em; }
        .modal-buttons { display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap; justify-content: center; }
        .modal-buttons button { flex-grow: 1; padding: 12px; font-size: 1em; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: transform 0.2s; min-width: 150px; }
        .modal-buttons button:hover { transform: scale(1.05); }
        .btn-confirm { background-color: var(--premium-glow); color: #000; } .btn-cancel { background-color: var(--sunk-color); color: #fff; }

        #grand-prize-ships { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 20px; perspective: 1000px; }
        .ship-choice { background: none; border: none; cursor: pointer; padding: 0; }
        .flipper { position: relative; width: 100px; height: 100px; transition: transform 0.8s; transform-style: preserve-3d; }
        .ship-choice.is-flipped .flipper { transform: rotateY(180deg); }
        .front, .back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; flex-direction: column; border-radius: 15px; border: 2px solid var(--cell-border); }
        .front { background: rgba(0,0,0,0.3); }
        .back { transform: rotateY(180deg); font-family: 'Orbitron'; font-size: 1.5em; padding: 5px; line-height: 1.2; }
        .back.bankrupt { background: #4d0000; text-shadow: 0 0 10px #000; font-size: 1.2em; }
        .back.sunk { background: #8B0000; text-shadow: 0 0 10px #000; }
        .back.safe { background: #003366; text-shadow: 0 0 10px #fff; }
        .back.double { background: #006400; text-shadow: 0 0 10px #fff; }
        .back.triple { background: var(--premium-glow); color: #000; text-shadow: 0 0 10px #fff; }
        .back.money { background: #4682B4; }
        .back.aid { background: #6a0dad; }
        
        .front svg { width: 70px; height: 70px; fill: var(--cell-border); transition: all 0.3s ease; }
        .ship-choice:hover:not(:disabled) .front svg { fill: var(--premium-glow); transform: scale(1.1); }
        #grand-prize-result { margin-top: 20px; height: 50px; font-size: 1.2em; font-weight: bold; }

        @keyframes pulse { 50% { text-shadow: 0 0 15px var(--premium-glow); } }
        @keyframes hit-shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes sink-animation { 0% { background-color: var(--hit-color); transform: scale(1.1); border-color: white; } 50% { background-color: var(--hit-color); transform: scale(0.8); opacity: 0.8; } 100% { background-color: var(--sunk-color); transform: scale(1); opacity: 0.6; border-color: var(--sunk-color); } }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="main-panel">
            <div id="game-header"><h1>Globális Torpedó</h1></div>
            <div id="message-container"></div>
            <div id="stats-panel">
                <div id="shots-stat" class="stat"><h3>Lőszer</h3><p>30</p></div>
                <div id="score-stat" class="stat"><h3>Kassza</h3><p>0 Ft</p></div>
                <div id="premium-stat" class="stat"><h3>Prémium</h3><p>0</p></div>
                <div id="ships-left-stat" class="stat"><h3>Hajók</h3><p>7</p></div>
            </div>
            <table id="game-board"></table>
            <div id="waiting-panel">
                <h2 id="waiting-title">PIHENŐ A FEDÉLZETEN</h2>
                <div id="waiting-info">
                    <p>Aktuális vagyon: <span id="waiting-score">0 Ft</span></p>
                    <p>A következő portya indul: <span id="waiting-time">00:00-kor</span></p>
                </div>
                <div id="rules-container">
                    <h3>Játékszabályzat</h3>
                    <ul>
                        <li><strong>Cél:</strong> Süllyeszd el az összes (7) ellenséges hajót a pályán.</li>
                        <li><strong>Lőszer:</strong> 30 lövéssel kezdesz. Ha elfogy, vásárolhatsz vagy eladhatod a zsákmányod.</li>
                        <li><strong>Találati Lánc:</strong> Minden találatért +1 prémium lövést kapsz. Amíg van prémium lövésed, a rendszer azt használja. A prémium lövés csak akkor fogy el, ha mellélősz.</li>
                        <li><strong>Nyereménytárgyak:</strong> Minden új kör, amit a tárggyal a birtokodban kezdesz, <strong>25%-kal növeli annak értékét!</strong></li>
                        <li><strong>Fődíj Játék:</strong> A győztes kör végén válassz egyet a 10 hajó közül a végső jutalomért!</li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="side-panel">
            <div id="time-info" class="side-box">
                <h2>Élő Adás</h2>
                <p id="current-time">00:00:00</p>
                <button id="new-map-button">Új Vizekre, Kapitány!</button>
            </div>
            <div id="shop" class="side-box">
                <h2>Arzenál</h2>
                <div class="shop-item">
                    <button id="use-sonar">Szónár Bevetése</button>
                    <div class="item-badge" id="sonar-charges-badge">0</div>
                </div>
                <div class="shop-item">
                     <button id="use-strike">Célzott Csapás</button>
                     <div class="item-badge" id="strike-charges-badge">0</div>
                </div>
                 <hr style="border-color: var(--cell-border); margin: 15px 0;">
                <button id="buy-shots">+10 Lőszer (75 000 Ft)</button>
            </div>
            <div id="fleet-status" class="side-box">
                <h2>Flotta</h2><ul id="fleet-list"></ul>
            </div>
            <div id="prize-corner" class="side-box">
                <h2>Zsákmány</h2><ul id="prize-list"></ul>
            </div>
        </div>
    </div>
    
    <div id="prize-modal" class="modal"><div class="modal-content"><h2>NYEREMÉNYTÁRGY!</h2><p>Eltaláltad ezt: <strong id="prize-name"></strong>!</p><p>Mit választasz?</p><div class="modal-buttons"><button id="btn-collect-prize" class="btn-cancel">Megtartom</button><button id="btn-collect-points" class="btn-confirm"></button></div></div></div>
    <div id="grand-prize-modal" class="modal"><div class="modal-content"><h2>FŐDÍJ JÁTÉK!</h2><p>Válassz egyet a hadihajók közül a végső jutalomért! A szerencse a bátraknak kedvez...</p><div id="grand-prize-ships"></div><div id="grand-prize-result"></div><div class="modal-buttons" style="margin-top: 15px;"><button id="btn-close-grand-prize" class="btn-confirm" style="display:none;">Rendben</button></div></div></div>
    <div id="temptation-modal" class="modal"><div class="modal-content"><h2>EGY AJÁNLAT...</h2><p id="temptation-text"></p><div class="modal-buttons"><button id="btn-reject-offer" class="btn-cancel">NEM, MARADOK!</button><button id="btn-accept-offer" class="btn-confirm">IGEN, CSERÉLEK!</button></div></div></div>
    <div id="out-of-ammo-modal" class="modal"><div class="modal-content"><h2>VÉSZHELYZET A FEDÉLZETEN!</h2><p id="ammo-modal-text">Kapitány, kifogytunk a lőszerből! Mit tegyünk?</p><div class="modal-buttons"><button id="btn-ammo-buy" class="btn-confirm">Lőszer Vásárlása</button><button id="btn-ammo-sell" class="btn-confirm">Zsákmány Beváltása</button><button id="btn-ammo-end" class="btn-cancel">Harci Álláspont Elhagyása</button></div></div></div>
    <div id="svg-definitions" style="display: none;"><svg id="miss-svg" viewBox="0 0 100 100"><path d="M 20 50 Q 50 20 80 50 M 30 60 Q 50 40 70 60" stroke="#FFF" stroke-width="8" fill="none" /></svg><svg id="hit-svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="25" fill="#FFF" /><circle cx="50" cy="50" r="15" fill="var(--hit-color)" /></svg><svg id="prize-svg" viewBox="0 0 24 24"><path fill="currentColor" d="M20.2,12.2C22.4,10.2 22,6.6 20,5C18.4,3.4 14.8,3 12.8,5.2L11.4,6.6L12.8,8L8,12.8L6.6,11.4L5.2,12.8C3,14.8 3.4,18.4 5,20C6.6,21.6 10.2,22 12.2,19.8L19.8,12.2M18,8.4L15.6,6L14.2,7.4L16.6,9.8L18,8.4M6,15.6L8.4,18L9.8,16.6L7.4,14.2L6,15.6M2,22L6,18L4,16L0,20V22H2M20,0H22V2L18,6L16,4L20,0M2,0H0V2L4,6L6,4L2,0Z"/></svg></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Game Config ---
    const boardSize = 10;
    const MAP_REFRESH_INTERVAL = 5 * 60 * 1000;
    const PRICES = { shots: 75000 };
    const shipTypes = [ { name: "Hordozó", size: 5, id: 'carrier' }, { name: "Csatahajó", size: 4, id: 'battleship' }, { name: "Cirkáló", size: 3, id: 'cruiser' }, { name: "Tengeralattjáró", size: 3, id: 'submarine' }, { name: "Romboló", size: 2, id: 'destroyer' }, { name: "Aknaszedő", size: 2, id: 'minesweeper' }, { name: "Motorcsónak", size: 1, id: 'speedboat' } ];
    const prizeTypes = [ { name: "Gumicsirke", id: 'chicken', value: 15000 }, { name: "Lyukas Gumicsónak", id: 'boat', value: 25000 }, { name: "A Szomszéd Macskája", id: 'cat', value: 40000 }, { name: "Egy Csomag Ropi", id: 'ropi', value: 10000 } ];

    // --- DOM Elements ---
    const gameBoardEl = document.getElementById('game-board'), messageEl = document.getElementById('message-container'), prizeModal = document.getElementById('prize-modal'), grandPrizeModal = document.getElementById('grand-prize-modal'), temptationModal = document.getElementById('temptation-modal'), outOfAmmoModal = document.getElementById('out-of-ammo-modal'), shotsEl = document.querySelector('#shots-stat p'), scoreEl = document.querySelector('#score-stat p'), premiumEl = document.querySelector('#premium-stat p'), premiumStatEl = document.getElementById('premium-stat'), shipsLeftEl = document.querySelector('#ships-left-stat p'), fleetListEl = document.getElementById('fleet-list'), prizeListEl = document.getElementById('prize-list'), newGameButton = document.getElementById('new-map-button'), currentTimeEl = document.getElementById('current-time'), waitingPanel = document.getElementById('waiting-panel'), waitingTimeEl = document.getElementById('waiting-time'), waitingScoreEl = document.getElementById('waiting-score'), buyShotsBtn = document.getElementById('buy-shots'), useSonarBtn = document.getElementById('use-sonar'), useStrikeBtn = document.getElementById('use-strike'), sonarChargesBadge = document.getElementById('sonar-charges-badge'), strikeChargesBadge = document.getElementById('strike-charges-badge');
    
    // --- Icons ---
    const icons = { miss: document.getElementById('miss-svg'), hit: document.getElementById('hit-svg'), prize: document.getElementById('prize-svg') };
    
    // --- Game State ---
    let boardState, ships, boardPrizes, shots, roundMoney, premiumShots, gameOver, currentMapSeed, seededRandom;
    let totalMoney = 0;
    let playerInventory = [];
    let gameInProgress = false;
    let playerSonarCharges = 0, playerStrikeCharges = 0;

    // --- Core Functions ---
    const mulberry32 = (a) => () => { let t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; };
    
    // --- Persistence ---
    function saveState() { const gameState = { totalMoney: totalMoney + roundMoney, inventory: playerInventory, lastMapSeed: currentMapSeed, sonar: playerSonarCharges, strike: playerStrikeCharges }; localStorage.setItem('globalTorpedoSave', JSON.stringify(gameState)); }
    function loadState() { const savedState = localStorage.getItem('globalTorpedoSave'); if (savedState) { const data = JSON.parse(savedState); totalMoney = data.totalMoney || 0; playerInventory = data.inventory || []; playerSonarCharges = data.sonar || 0; playerStrikeCharges = data.strike || 0; } }

    // --- Game Initialization ---
    function initGame() {
        currentMapSeed = Math.floor(Date.now() / MAP_REFRESH_INTERVAL);
        const savedState = JSON.parse(localStorage.getItem('globalTorpedoSave'));
        if (savedState && savedState.lastMapSeed === currentMapSeed) { showWaitingScreen(); return; }
        seededRandom = mulberry32(currentMapSeed);
        shots = 30; roundMoney = 0; premiumShots = 0; gameOver = false; gameInProgress = false;
        boardState = Array(boardSize).fill(null).map(() => Array(boardSize).fill(null).map(() => ({ shipId: null, prizeId: null, state: 'empty' })));
        displayMessage("Új pálya betöltve! Kezdődjön a csata!", 3000);
        newGameButton.style.display = 'none'; waitingPanel.style.display = 'none'; gameBoardEl.style.display = 'table'; document.getElementById('stats-panel').style.display = 'grid';
        placeShips(); placePrizes(); renderBoard(); renderFleetStatus(); renderPrizeList(); updateStats();
    }
    
    function showWaitingScreen() {
        gameBoardEl.style.display = 'none'; document.getElementById('stats-panel').style.display = 'none'; newGameButton.style.display = 'none'; waitingPanel.style.display = 'block';
        updateStats();
    }

    // --- Placement and Rendering ---
    function placeItems(items, idKey, placementFunc) { items.forEach(item => { let placed = false; while (!placed) { const o = seededRandom() < 0.5 ? 'h' : 'v'; const sr = Math.floor(seededRandom() * boardSize); const sc = Math.floor(seededRandom() * boardSize); if (isValidPlacement(item, sr, sc, o)) { placementFunc(item, sr, sc, o); placed = true; } } }); }
    function placeShips() { ships = []; placeItems(shipTypes, 'shipId', (shipType, sr, sc, o) => { const coords = []; for (let i = 0; i < shipType.size; i++) { const r = o === 'h' ? sr : sr + i; const c = o === 'h' ? sc + i : sc; boardState[r][c].shipId = shipType.id; coords.push({ row: r, col: c }); } ships.push({ ...shipType, coords, hits: 0, sunk: false }); }); }
    function placePrizes() { boardPrizes = prizeTypes.map(p => ({...p})); placeItems(boardPrizes, 'prizeId', (prize, r, c) => { boardState[r][c].prizeId = prize.id; }); }
    function isValidPlacement(item, row, col, o) { const size = item.size || 1; if ((o === 'h' && col + size > boardSize) || (o === 'v' && row + size > boardSize)) return false; for (let i = 0; i < size; i++) { const r = o === 'h' ? row : row + i; const c = o === 'h' ? col + i : col; for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) { const cr = r + dr, cc = c + dc; if (cr >= 0 && cr < boardSize && cc >= 0 && cc < boardSize && (boardState[cr][cc].shipId !== null || boardState[cr][cc].prizeId !== null)) return false; } } return true; }
    function renderBoard() { gameBoardEl.innerHTML = `<tr><th></th>${Array.from({length:10}, (_,i)=>`<th>${String.fromCharCode(65+i)}</th>`).join('')}</tr>`; for (let i = 0; i < boardSize; i++) { const rowEl = gameBoardEl.insertRow(); rowEl.innerHTML = `<th>${i + 1}</th>`; for (let j = 0; j < boardSize; j++) { const cellEl = rowEl.insertCell(); cellEl.dataset.row = i; cellEl.dataset.col = j; cellEl.addEventListener('click', handleCellClick); } } }
    function renderFleetStatus() { fleetListEl.innerHTML = ships.map(ship => `<li id="fleet-${ship.id}" class="${ship.sunk ? 'sunk' : ''}">${ship.name} (${ship.size})</li>`).join(''); }
    
    function renderPrizeList() {
        prizeListEl.innerHTML = playerInventory.length ? playerInventory.map(p => { const currentValue = Math.floor(p.value * (1 + 0.25 * (p.heldRounds || 0))); return `<li><span>${p.name}</span><button class="sell-prize-btn" data-prize-id="${p.id}">Eladom (${currentValue.toLocaleString()} Ft)</button></li>`}).join('') : '<li>Még nincs zsákmányod</li>';
        document.querySelectorAll('.sell-prize-btn').forEach(btn => btn.addEventListener('click', handleSellPrize));
    }

    // --- Gameplay Handlers ---
    function handleSellPrize(e) { const prizeId = e.target.dataset.prizeId; const prizeIndex = playerInventory.findIndex(p => p.id === prizeId); if (prizeIndex > -1) { const soldPrize = playerInventory.splice(prizeIndex, 1)[0]; const currentValue = Math.floor(soldPrize.value * (1 + 0.25 * (soldPrize.heldRounds || 0))); totalMoney += currentValue; displayMessage(`${soldPrize.name} eladva!`, 2000); renderPrizeList(); updateStats(); saveState(); } }
    
    function handleCellClick(e) {
        if (gameOver || waitingPanel.style.display === 'block') return;
        if (!gameInProgress) { gameInProgress = true; }
        const targetCell = e.target.closest('td'); if (!targetCell) return;
        const row = parseInt(targetCell.dataset.row), col = parseInt(targetCell.dataset.col);
        const cellState = boardState[row][col];
        if (cellState.state !== 'empty') return;
        if(shots <= 0 && premiumShots <= 0) { showOutOfAmmoModal(); return; }
        
        const isPremiumShot = premiumShots > 0;
        targetCell.classList.add('shot');
        
        if (cellState.shipId) { // It's a HIT
            if (!isPremiumShot) { shots--; }
            handleHit(targetCell, isPremiumShot);
        } else { // It's a MISS or PRIZE
            if (isPremiumShot) { premiumShots--; } 
            else { shots--; }
            
            if (cellState.prizeId) { handlePrize(targetCell); } 
            else { handleMiss(targetCell); }
        }
        updateStats();
        checkGameOver();
    }

    function handleHit(cellEl, wasPremium) { const row = cellEl.dataset.row, col = cellEl.dataset.col; boardState[row][col].state = 'hit'; cellEl.classList.add('hit'); const icon = icons.hit.cloneNode(true); icon.classList.add('icon'); cellEl.appendChild(icon); roundMoney += wasPremium ? 2500 : 500; premiumShots += 1; displayMessage(`TALÁLAT!`, 1500, () => displayMessage("PRÉMIUM LÖVÉS! +1", 1500)); const hitShip = ships.find(ship => ship.id === boardState[row][col].shipId); hitShip.hits++; if (hitShip.hits === hitShip.size) handleSunkShip(hitShip); }
    function handlePrize(cellEl) { cellEl.classList.add('prize'); const icon = icons.prize.cloneNode(true); icon.classList.add('icon'); cellEl.appendChild(icon); const prize = boardPrizes.find(p => p.id === boardState[cellEl.dataset.row][cellEl.dataset.col].prizeId); showPrizeModal(prize); }
    function handleMiss(cellEl) { cellEl.classList.add('miss'); const icon = icons.miss.cloneNode(true); icon.classList.add('icon'); cellEl.appendChild(icon); displayMessage("MELLÉ!", 1500); }
    function handleSunkShip(sunkShip) { sunkShip.sunk = true; roundMoney += 10000; displayMessage(`${sunkShip.name} elsüllyedt! +10 000 Ft`, 3000); sunkShip.coords.forEach(({ row, col }) => { gameBoardEl.querySelector(`[data-row='${row}'][data-col='${col}']`).classList.add('sunk'); }); renderFleetStatus(); }
    function showPrizeModal(prize) { gameOver = true; document.getElementById('prize-name').textContent = prize.name; document.getElementById('btn-collect-points').textContent = `${prize.value.toLocaleString()} Ft-ért eladom`; const collectHandler = () => { playerInventory.push({ ...prize, heldRounds: 0 }); renderPrizeList(); closePrizeModal(); saveState(); }; const cashHandler = () => { roundMoney += prize.value; closePrizeModal(); }; document.getElementById('btn-collect-prize').onclick = collectHandler; document.getElementById('btn-collect-points').onclick = cashHandler; prizeModal.classList.add('visible'); }
    function closePrizeModal() { prizeModal.classList.remove('visible'); gameOver = false; updateStats(); }
    
    function checkGameOver() { if (!gameOver && ships.every(ship => ship.sunk)) { gameOver = true; premiumShots = 0; updateStats(); startGrandPrizeGame(); } }
    function endGameNoAmmo() { gameOver = true; totalMoney += roundMoney; roundMoney = 0; displayMessage("VÉGE A JÁTÉKNAK!", 5000); updateStats(); saveState(); setTimeout(showWaitingScreen, 3000); }

    function showOutOfAmmoModal() {
        const canBuy = (totalMoney + roundMoney) >= PRICES.shots;
        const canSell = playerInventory.length > 0;
        document.getElementById('btn-ammo-buy').style.display = canBuy ? 'block' : 'none';
        document.getElementById('btn-ammo-sell').style.display = canSell ? 'block' : 'none';
        if (!canBuy && !canSell) { document.getElementById('ammo-modal-text').textContent = "Nincs elég pénzed lőszerre és nincs mit eladnod. A csatának vége!"; } 
        else { document.getElementById('ammo-modal-text').textContent = "Kapitány, kifogytunk a lőszerből! Mit tegyünk?"; }
        outOfAmmoModal.classList.add('visible');
    }

    document.getElementById('btn-ammo-buy').addEventListener('click', () => outOfAmmoModal.classList.remove('visible'));
    document.getElementById('btn-ammo-sell').addEventListener('click', () => outOfAmmoModal.classList.remove('visible'));
    document.getElementById('btn-ammo-end').addEventListener('click', () => { outOfAmmoModal.classList.remove('visible'); endGameNoAmmo(); });

    function startGrandPrizeGame() {
        const container = document.getElementById('grand-prize-ships'); container.innerHTML = '';
        for (let i = 0; i < 10; i++) { container.innerHTML += `<button class="ship-choice" data-index="${i}"><div class="flipper"><div class="front"><svg viewBox="0 0 64 64"><path d="M61.9,25.9c-0.2-0.7-0.9-1.1-1.6-0.9l-7.4,1.9c-2-6.5-8.1-11.4-15.3-11.4h-1.2V9.9c0-2.8-2.2-5-5-5s-5,2.2-5,5v5.6h-1.2 c-7.2,0-13.3,4.9-15.3,11.4l-7.4-1.9c-0.7-0.2-1.4,0.2-1.6,0.9s0.2,1.4,0.9,1.6l7.4,1.9c-0.2,0.9-0.3,1.9-0.3,2.9v1.8H2V48h60V32.3 h-2v-1.8C62.2,28.8,62.2,27.2,61.9,25.9z M32,23.5c4.4,0,8,3.6,8,8s-3.6,8-8,8s-8-3.6-8-8S27.6,23.5,32,23.5z"/></svg></div><div class="back"></div></div></button>`; }
        const shipChoices = document.querySelectorAll('.ship-choice'); const closeBtn = document.getElementById('btn-close-grand-prize'); document.getElementById('grand-prize-result').innerHTML = ""; closeBtn.style.display = 'none';
        const prizePool = [ { type: 'bankrupt', label: 'CSŐD' }, { type: 'sunk', label: 'X' }, { type: 'money', value: 25000, label: '+25e Ft' }, { type: 'money', value: 50000, label: '+50e Ft' }, { type: 'money', value: 100000, label: '+100e Ft' }, { type: 'aid', aidType: 'sonar', label: '+1 Szónár' }, { type: 'aid', aidType: 'strike', label: '+1 Csapás' }, { type: 'double', label: '2X' }, { type: 'triple', label: '3X' }, { type: 'safe', label: '1X' } ];
        for (let i = prizePool.length - 1; i > 0; i--) { const j = Math.floor(seededRandom() * (i + 1)); [prizePool[i], prizePool[j]] = [prizePool[j], prizePool[i]]; }
        
        const revealChoice = (choiceIndex) => {
            let resultText = ""; const result = prizePool[choiceIndex];
            if (result.type === 'bankrupt') { totalMoney = 0; roundMoney = 0; playerSonarCharges = 0; playerStrikeCharges = 0; resultText = `TELJES CSŐD! Minden elveszett!`; } 
            else if (result.type === 'sunk') { roundMoney = 0; resultText = `ELSÜLLYEDT! Elveszett a kör nyereménye!`; } 
            else if (result.type === 'safe') { resultText = `MENTŐCSÓNAK! Megtartottad a kör nyereményét.`; } 
            else if (result.type === 'double') { roundMoney *= 2; resultText = `DUPLÁZÓ! Nyeremény: ${roundMoney.toLocaleString()} Ft!`; } 
            else if (result.type === 'triple') { roundMoney *= 3; resultText = `TRIPLÁZÓ! Nyeremény: ${roundMoney.toLocaleString()} Ft!`; }
            else if (result.type === 'money') { roundMoney += result.value; resultText = `Készpénz! +${result.value.toLocaleString()} Ft!`; }
            else if (result.type === 'aid') { if(result.aidType === 'sonar') { playerSonarCharges++; resultText = `Felszerelés! +1 Szónár!`; } else { playerStrikeCharges++; resultText = `Felszerelés! +1 Célzott Csapás!`; } }
            totalMoney += roundMoney; roundMoney = 0; document.getElementById('grand-prize-result').textContent = resultText;
            shipChoices[choiceIndex].classList.add('is-flipped'); let delay = 500;
            shipChoices.forEach((ship, index) => { if(index === choiceIndex) return; setTimeout(() => ship.classList.add('is-flipped'), delay); delay += 100; });
            setTimeout(() => { closeBtn.style.display = 'block'; }, delay + 200);
        };

        const choiceHandler = (e) => {
            const btn = e.currentTarget; if(btn.classList.contains('is-flipped')) return;
            const choiceIndex = parseInt(btn.dataset.index);
            shipChoices.forEach(s => s.removeEventListener('click', choiceHandler));
            shipChoices.forEach((ship, index) => { const back = ship.querySelector('.back'); const prize = prizePool[index]; back.className = `back ${prize.type}`; back.textContent = prize.label; });
            if (roundMoney > 10000 && seededRandom() < 0.33) {
                const guaranteedAmount = Math.floor(roundMoney * 0.7 / 1000) * 1000;
                document.getElementById('temptation-text').textContent = `Biztos vagy a dolgodban? Vagy inkább elfogadsz garantált ${guaranteedAmount.toLocaleString()} Ft-ot?`;
                document.getElementById('btn-reject-offer').onclick = () => { temptationModal.classList.remove('visible'); revealChoice(choiceIndex); };
                document.getElementById('btn-accept-offer').onclick = () => { temptationModal.classList.remove('visible'); totalMoney += guaranteedAmount; roundMoney = 0; revealChoice(choiceIndex); };
                setTimeout(() => temptationModal.classList.add('visible'), 500);
            } else { revealChoice(choiceIndex); }
        };

        shipChoices.forEach(btn => btn.addEventListener('click', choiceHandler));
        closeBtn.onclick = () => { grandPrizeModal.classList.remove('visible'); saveState(); showWaitingScreen(); };
        grandPrizeModal.classList.add('visible');
    }
    
    // --- UI and Stats ---
    function updateStats() { const shipsRemaining = ships ? ships.filter(s => !s.sunk).length : 0, shipsTotal = ships ? ships.length : 7; const currentMoney = totalMoney + roundMoney; shotsEl.textContent = shots; scoreEl.textContent = `${currentMoney.toLocaleString()} Ft`; premiumEl.textContent = premiumShots; shipsLeftEl.textContent = `${shipsRemaining}/${shipsTotal}`; premiumStatEl.classList.toggle('active', premiumShots > 0 && !gameOver); buyShotsBtn.disabled = currentMoney < PRICES.shots; sonarChargesBadge.textContent = playerSonarCharges; strikeChargesBadge.textContent = playerStrikeCharges; useSonarBtn.disabled = playerSonarCharges <= 0; useStrikeBtn.disabled = playerStrikeCharges <= 0; waitingScoreEl.textContent = `${currentMoney.toLocaleString()} Ft`; }
    function displayMessage(text, duration = 2000, callback) { messageEl.textContent = text; setTimeout(() => { if (messageEl.textContent === text) { messageEl.textContent = ''; } if (callback) callback(); }, duration); }
    
    // --- Shop and Arsenal ---
    function purchase(cost, callback) { if (totalMoney + roundMoney >= cost) { let rem = cost; if (roundMoney > 0) { const fromRound = Math.min(roundMoney, rem); roundMoney -= fromRound; rem -= fromRound; } if (rem > 0) { totalMoney -= rem; } callback(); updateStats(); saveState(); } else { displayMessage("Nincs elég pénzed!", 2000); } }
    buyShotsBtn.addEventListener('click', () => purchase(PRICES.shots, () => { shots += 10; displayMessage("+10 Lőszer vásárolva!", 2000); }));
    useSonarBtn.addEventListener('click', () => { if(playerSonarCharges > 0) { playerSonarCharges--; displayMessage("SZÓNÁR BEVETVE!", 4000); updateStats(); saveState(); } });
    useStrikeBtn.addEventListener('click', () => { if(playerStrikeCharges > 0) { playerStrikeCharges--; displayMessage("CÉLZOTT CSAPÁS!", 2000); updateStats(); saveState(); } });

    // --- Time Management ---
    function tick() {
        const now = new Date(), millis = now.getTime();
        currentTimeEl.textContent = now.toLocaleTimeString('hu-HU');
        const nextMapTimestamp = (Math.floor(millis / MAP_REFRESH_INTERVAL) + 1) * MAP_REFRESH_INTERVAL;
        const nextMapDate = new Date(nextMapTimestamp);
        const timeString = nextMapDate.toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' });
        waitingTimeEl.textContent = `${timeString}-kor`;
        const newSeed = Math.floor(millis / MAP_REFRESH_INTERVAL);
        if (newSeed > currentMapSeed) {
            if (gameInProgress && !gameOver) { newGameButton.style.display = 'block'; } 
            else if(waitingPanel.style.display === 'block') { startNewRound(); }
        }
    }

    function startNewRound() {
        totalMoney += roundMoney; roundMoney = 0;
        playerInventory.forEach(p => p.heldRounds = (p.heldRounds || 0) + 1);
        saveState(); initGame();
    }

    // --- Initial Load ---
    window.addEventListener('beforeunload', saveState);
    newGameButton.addEventListener('click', startNewRound);
    loadState();
    setInterval(tick, 1000);
    initGame();
});
</script>
</body>
</html>```