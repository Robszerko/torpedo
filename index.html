<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Globális Torpedó</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@800&family=Poppins:wght@400;600&display=swap');

        :root {
            --cell-bg: rgba(255, 255, 255, 0.05); 
            --cell-border: #8e9eab;
            --text-color: #E0E5EC; --hit-color: #ff4757; --miss-color: #537895;
            --sunk-color: #343a40; --prize-color: #feca57; --premium-glow: #ffd700;
        }

        body {
            font-family: 'Poppins', sans-serif; display: flex; align-items: center; justify-content: center;
            min-height: 100vh; color: var(--text-color); margin: 0; padding: 20px; box-sizing: border-box;
            background-image: linear-gradient(to bottom, rgba(9, 20, 27, 0.85), rgba(15, 32, 39, 0.9)), url('https://images.pexels.com/photos/220201/pexels-photo-220201.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
            background-size: cover; background-position: center center; background-attachment: fixed; background-repeat: no-repeat;
        }

        #game-container {
            width: 100%; max-width: 950px; 
            background: transparent;
            padding: 0;
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr 260px;
            grid-template-rows: auto 1fr;
            grid-template-areas:
                "main side"
                "main side";
        }

        #main-panel { grid-area: main; min-width: 320px; }
        #side-panel { grid-area: side; width: 260px; flex-shrink: 0; display: flex; flex-direction: column; gap: 20px;}

        #game-header { text-align: center; margin-bottom: 20px; }
        #game-header h1 {
            font-family: 'Orbitron', sans-serif; font-size: clamp(2.5rem, 8vw, 4rem); color: white;
            margin: 0; text-shadow: 0 0 10px var(--cell-border), 0 0 20px var(--cell-border);
        }
        
        #stats-panel { display: flex; justify-content: space-around; gap: 5px; margin-bottom: 20px; text-align: center; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 15px; border: 1px solid rgba(142, 158, 171, 0.5); }
        .stat { background: none; border: none; padding: 5px; }
        .stat h3 { margin: 0; font-size: 0.7em; color: var(--cell-border); text-transform: uppercase; font-weight: 400; }
        .stat p { margin: 2px 0 0 0; font-size: 1.2em; font-weight: 600; font-family: 'Orbitron'; }
        #premium-stat.active p { color: var(--premium-glow); animation: pulse 1.5s infinite; }

        #board-wrapper { position: relative; }
        #board-message-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Orbitron', sans-serif; font-size: clamp(2rem, 10vw, 3.5rem);
            color: var(--premium-glow); text-shadow: 0 0 10px #000, 0 0 20px var(--premium-glow);
            pointer-events: none; opacity: 0; z-index: 10;
            text-align: center; text-transform: uppercase;
        }

        #game-board { border-collapse: separate; border-spacing: 4px; margin: 0 auto; }
        #game-board th, #game-board td { width: clamp(28px, 6.5vw, 40px); height: clamp(28px, 6.5vw, 40px); text-align: center; font-family: 'Orbitron'; color: var(--cell-border); vertical-align: middle; user-select: none; }
        #game-board th { background: rgba(255, 255, 255, 0.03); border-radius: 8px; }
        #game-board td { background: transparent; border: 2px solid var(--cell-border); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative; }
        #game-board td:hover:not(.shot) { background-color: rgba(142, 158, 171, 0.3); transform: scale(1.05); }
        #game-board td.shot { cursor: not-allowed; } #game-board td.shot:hover { transform: none; }
        #game-board td.miss { background-color: var(--miss-color); }
        #game-board td.hit { background-color: var(--hit-color); animation: hit-shake 0.5s; }
        #game-board td.sunk { animation: sink-animation 1s forwards; }
        #game-board td.prize { background-color: var(--prize-color); border-color: #FFF; box-shadow: 0 0 15px var(--prize-color); }
        
        #waiting-panel { display: none; text-align: center; padding: 20px; background: rgba(9, 20, 27, 0.9); border: 1px solid var(--premium-glow); border-radius: 20px; }
        #waiting-title { font-family: 'Orbitron'; font-size: 2em; color: var(--premium-glow); margin-bottom: 10px; }
        #waiting-info { font-family: 'Poppins'; font-size: 1.2em; margin: 15px 0; color: white; }
        #waiting-time, #waiting-score, #live-time-waiting { font-family: 'Orbitron'; font-size: 1.5em; color: var(--premium-glow); }
        #rules-container { text-align: left; font-size: 0.9em; padding: 15px; border-top: 1px solid var(--cell-border); margin-top: 15px; }
        #rules-container h3 { color: var(--premium-glow); border-bottom: 1px solid var(--premium-glow); padding-bottom: 5px; margin-top: 0; }
        #rules-container ul { padding-left: 20px; margin: 10px 0 0 0; }
        #rules-container li { margin-bottom: 8px; }

        .icon { width: 70%; height: 70%; vertical-align: middle; position: absolute; top: 15%; left: 15%; }
        
        .side-box { background: rgba(0,0,0,0.25); border: 1px solid var(--cell-border); border-radius: 15px; padding: 15px; }
        .side-box h2 { font-family: 'Orbitron'; text-align: center; color: var(--cell-border); border-bottom: 2px solid var(--cell-border); padding-bottom: 5px; margin-top: 0; font-size: 1.2em; }
        #fleet-list, #prize-list { list-style: none; padding: 0; margin: 0; }
        #fleet-list li, #prize-list li { background: var(--cell-bg); padding: 8px; border-radius: 8px; margin-bottom: 8px; font-weight: 600; transition: all 0.3s; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
        #fleet-list li.sunk { background-color: var(--sunk-color); color: #999; text-decoration: line-through; border: 1px solid #555; }
        
        #new-map-button { display: none; width: 100%; margin-top: 15px; padding: 12px; font-size: 1em; font-weight: 700; font-family: 'Orbitron'; color: #000; background-color: var(--premium-glow); border: none; border-radius: 15px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 0 20px var(--premium-glow); }
        #new-map-button:hover { transform: scale(1.05); }
        
        #shop-items button, .sell-prize-btn { padding: 10px; margin-bottom: 8px; background-color: var(--cell-bg); border: 1px solid var(--cell-border); color: var(--text-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .shop-item { position: relative; margin-bottom: 12px; }
        .shop-item button { width: 100%; margin: 0; }
        .shop-item p.item-desc { font-size: 0.8em; color: var(--cell-border); text-align: center; margin: 4px 0 0 0; }
        .shop-item button:not(:disabled) { border-color: var(--premium-glow); box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        .item-badge { position: absolute; top: -5px; right: -5px; background-color: var(--premium-glow); color: #000; border-radius: 50%; width: 22px; height: 22px; line-height: 22px; text-align: center; font-weight: bold; font-size: 0.9em; box-shadow: 0 0 10px var(--premium-glow); }
        .sell-prize-btn { font-size: 0.8em; padding: 4px 8px; margin: 0; background-color: var(--premium-glow); color: #000; font-weight: bold; }
        #shop-items button:hover:not(:disabled), .sell-prize-btn:hover { background-color: rgba(142, 158, 171, 0.4); }
        #shop-items button:disabled { cursor: not-allowed; opacity: 0.5; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content { background: linear-gradient(145deg, #232526, #414345); border: 2px solid var(--premium-glow); border-radius: 20px; padding: 30px; text-align: center; color: white; width: 90%; max-width: 650px; transform: scale(0.9); transition: transform 0.3s; box-shadow: 0 0 30px var(--premium-glow); }
        .modal.visible .modal-content { transform: scale(1); }
        .modal-content h2 { font-family: 'Orbitron'; margin-top: 0; font-size: 2.2em; text-shadow: 0 0 10px var(--premium-glow); } 
        .modal-content p { font-size: 1.1em; }
        .modal-buttons { display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap; justify-content: center; }
        .modal-buttons button { flex-grow: 1; padding: 12px; font-size: 1em; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: transform 0.2s; min-width: 150px; }
        .modal-buttons button:hover { transform: scale(1.05); }
        .btn-confirm { background-color: var(--premium-glow); color: #000; } .btn-cancel { background-color: var(--sunk-color); color: #fff; }
        .modal-content input[type=number] { width: 80px; padding: 8px; text-align: center; background: var(--cell-bg); border: 1px solid var(--cell-border); color: white; border-radius: 8px; font-size: 1.2em; font-family: 'Orbitron'; }

        #grand-prize-ships { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 20px; perspective: 1000px; }
        .ship-choice { background: none; border: none; cursor: pointer; padding: 0; }
        .flipper { position: relative; width: 100px; height: 100px; transition: transform 0.8s; transform-style: preserve-3d; }
        .ship-choice.is-flipped .flipper { transform: rotateY(180deg); }
        .front, .back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; flex-direction: column; border-radius: 15px; border: 2px solid var(--cell-border); }
        .front { background: rgba(0,0,0,0.3); }
        .back { transform: rotateY(180deg); font-family: 'Orbitron'; font-size: 1.5em; padding: 5px; line-height: 1.2; }
        .back.bankrupt { background: #4d0000; text-shadow: 0 0 10px #000; font-size: 1.2em; }
        .back.sunk { background: #8B0000; text-shadow: 0 0 10px #000; }
        .back.safe { background: #003366; text-shadow: 0 0 10px #fff; }
        .back.double { background: #006400; text-shadow: 0 0 10px #fff; }
        .back.triple { background: var(--premium-glow); color: #000; text-shadow: 0 0 10px #fff; }
        .back.money { background: #4682B4; }
        .back.aid { background: #6a0dad; }
        
        .front svg { width: 70px; height: 70px; fill: var(--cell-border); transition: all 0.3s ease; }
        .ship-choice:hover:not(:disabled) .front svg { fill: var(--premium-glow); transform: scale(1.1); }
        #grand-prize-result { margin-top: 20px; height: 50px; font-size: 1.2em; font-weight: bold; }

        @keyframes pulse { 50% { text-shadow: 0 0 15px var(--premium-glow); } }
        @keyframes hit-shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes sink-animation { 0% { background-color: var(--hit-color); transform: scale(1.1); border-color: white; } 50% { background-color: var(--hit-color); transform: scale(0.8); opacity: 0.8; } 100% { background-color: var(--sunk-color); transform: scale(1); opacity: 0.6; border-color: var(--sunk-color); } }
        @keyframes fade-in-out-zoom { 0% { transform: scale(0.8); opacity: 0; } 15% { transform: scale(1.1); opacity: 1; } 85% { transform: scale(1); opacity: 1; } 100% { transform: scale(0.9); opacity: 0; } }

        @media (max-width: 900px) {
            body { padding: 10px; }
            #game-container {
                display: flex;
                flex-direction: column;
                grid-template-columns: 1fr;
                grid-template-areas: "main" "side";
            }
            #main-panel { order: 1; }
            #side-panel { 
                order: 2; 
                width: 100%;
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 15px;
            }
            .side-box {
                flex-grow: 1;
                min-width: calc(50% - 10px);
            }
            #new-map-button { order: 3; }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="main-panel">
            <div id="game-header"><h1>Globális Torpedó</h1></div>
            <div id="stats-panel">
                <div id="shots-stat" class="stat"><h3>Lőszer</h3><p>30</p></div>
                <div id="score-stat" class="stat"><h3>Kassza</h3><p>0 Ft</p></div>
                <div id="premium-stat" class="stat"><h3>Prémium</h3><p>0</p></div>
                <div id="ships-left-stat" class="stat"><h3>Hajók</h3><p>7</p></div>
            </div>
            <div id="board-wrapper">
                <div id="board-message-overlay"></div>
                <table id="game-board"></table>
            </div>
            <div id="waiting-panel">
                <h2 id="waiting-title">PIHENŐ A FEDÉLZETEN</h2>
                <div id="waiting-info">
                    <p>Aktuális idő: <span id="live-time-waiting"></span></p>
                    <p>Aktuális vagyon: <span id="waiting-score">0 Ft</span></p>
                    <p>A következő portya indul: <span id="waiting-time">00:00-kor</span></p>
                </div>
                <div id="rules-container">
                    <h3>Játékszabályzat és Segítség</h3>
                    <ul>
                        <li><strong>Cél:</strong> Süllyeszd el az összes (7) ellenséges hajót a pályán.</li>
                        <li><strong>Lőszer:</strong> 30 lövéssel kezdesz. Ha elfogy, az Arzenálban vásárolhatsz darabonként 7 500 Ft-ért.</li>
                        <li><strong>Találati Lánc:</strong> Minden találatért +1 prémium lövést kapsz. Amíg van prémium lövésed, a rendszer azt használja. A prémium lövés csak akkor fogy el, ha mellélősz.</li>
                        <li><strong>Nyereménytárgyak:</strong> Minden új kör, amit a tárggyal a birtokodban kezdesz, <strong>25%-kal növeli annak értékét!</strong></li>
                        <li><strong>Fődíj Játék:</strong> A győztes kör végén válassz egyet a 10 hajó közül a végső jutalomért!</li>
                        <hr style="border-color: var(--cell-border); margin: 10px 0;">
                        <li><strong>Szónár Bevetése (200 000 Ft):</strong> Felfed egy 3x3-as területet a pályán, megmutatva, hogy van-e ott hajórészlet.</li>
                        <li><strong>Célzott Csapás (500 000 Ft):</strong> Lehetővé teszi egy már legalább egyszer eltalált, de még nem elsüllyedt hajó azonnali megsemmisítését.</li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="side-panel">
            <div id="shop" class="side-box">
                <h2>Arzenál</h2>
                <div id="shop-items">
                    <div class="shop-item"><button id="use-sonar">Szónár Bevetése</button><div class="item-badge" id="sonar-charges-badge">0</div></div>
                    <div class="shop-item"><button id="use-strike">Célzott Csapás</button><div class="item-badge" id="strike-charges-badge">0</div></div>
                    <hr style="border-color: var(--cell-border); margin: 15px 0;">
                    <button id="buy-sonar">+1 Szónár (200 000 Ft)</button>
                    <button id="buy-strike">+1 Csapás (500 000 Ft)</button>
                    <button id="open-buy-shots-modal">Lőszer Vásárlása</button>
                </div>
            </div>
            <div id="fleet-status" class="side-box">
                <h2>Flotta</h2><ul id="fleet-list"></ul>
            </div>
            <div id="prize-corner" class="side-box">
                <h2>Zsákmány</h2><ul id="prize-list"></ul>
            </div>
            <button id="new-map-button">Új Vizekre, Kapitány!</button>
        </div>
    </div>
    
    <div id="prize-modal" class="modal"><div class="modal-content"><h2>NYEREMÉNYTÁRGY!</h2><p>Eltaláltad ezt: <strong id="prize-name"></strong>!</p><p>Mit választasz?</p><div class="modal-buttons"><button id="btn-collect-prize" class="btn-cancel">Megtartom</button><button id="btn-collect-points" class="btn-confirm"></button></div></div></div>
    <div id="grand-prize-modal" class="modal"><div class="modal-content"><h2>FŐDÍJ JÁTÉK!</h2><p>Válassz egyet a hadihajók közül a végső jutalomért! A szerencse a bátraknak kedvez...</p><div id="grand-prize-ships"></div><div id="grand-prize-result"></div><div class="modal-buttons" style="margin-top: 15px;"><button id="btn-close-grand-prize" class="btn-confirm" style="display:none;">Rendben</button></div></div></div>
    <div id="temptation-modal" class="modal"><div class="modal-content"><h2>EGY AJÁNLAT...</h2><p id="temptation-text"></p><div class="modal-buttons"><button id="btn-reject-offer" class="btn-cancel">NEM, MARADOK!</button><button id="btn-accept-offer" class="btn-confirm">IGEN, CSERÉLEK!</button></div></div></div>
    <div id="out-of-ammo-modal" class="modal"><div class="modal-content"><h2>VÉSZHELYZET A FEDÉLZETEN!</h2><p id="ammo-modal-text">Kapitány, kifogytunk a lőszerből! Mit tegyünk?</p><div class="modal-buttons"><button id="btn-ammo-buy" class="btn-confirm">Lőszer Vásárlása</button><button id="btn-ammo-sell" class="btn-confirm">Zsákmány Beváltása</button><button id="btn-ammo-end" class="btn-cancel">Harci Álláspont Elhagyása</button></div></div></div>
    <div id="buy-ammo-modal" class="modal"><div class="modal-content"><h2>Lőszer Vásárlása</h2><p>Egy lövedék ára: 7 500 Ft.</p><div><label for="ammo-quantity" style="font-size: 1.2em; margin-right: 10px;">Mennyiség:</label><input type="number" id="ammo-quantity" min="1" value="1" step="1"></div><p style="margin-top: 20px; font-size: 1.3em;">Teljes költség: <strong id="ammo-total-cost">7 500 Ft</strong></p><div class="modal-buttons"><button id="btn-buy-ammo-confirm" class="btn-confirm">Vásárlás</button><button id="btn-buy-ammo-cancel" class="btn-cancel">Mégse</button></div></div></div>
    <div id="svg-definitions" style="display: none;"><svg id="miss-svg" viewBox="0 0 100 100"><path d="M 20 50 Q 50 20 80 50 M 30 60 Q 50 40 70 60" stroke="#FFF" stroke-width="8" fill="none" /></svg><svg id="hit-svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="25" fill="#FFF" /><circle cx="50" cy="50" r="15" fill="var(--hit-color)" /></svg><svg id="prize-svg" viewBox="0 0 24 24"><path fill="currentColor" d="M20.2,12.2C22.4,10.2 22,6.6 20,5C18.4,3.4 14.8,3 12.8,5.2L11.4,6.6L12.8,8L8,12.8L6.6,11.4L5.2,12.8C3,14.8 3.4,18.4 5,20C6.6,21.6 10.2,22 12.2,19.8L19.8,12.2M18,8.4L15.6,6L14.2,7.4L16.6,9.8L18,8.4M6,15.6L8.4,18L9.8,16.6L7.4,14.2L6,15.6M2,22L6,18L4,16L0,20V22H2M20,0H22V2L18,6L16,4L20,0M2,0H0V2L4,6L6,4L2,0Z"/></svg></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Game Config ---
    const boardSize = 10;
    const MAP_REFRESH_INTERVAL = 5 * 60 * 1000;
    const PRICES = { shot: 7500, sonar: 200000, strike: 500000 };
    
    const shipTypes = [
        { name: "Hordozó", id: 'carrier', shape: [{r:0,c:0},{r:1,c:0},{r:2,c:0},{r:2,c:1},{r:2,c:2}] }, // L-shape, size 5
        { name: "Csatahajó", id: 'battleship', shape: [{r:0,c:1},{r:1,c:0},{r:1,c:1},{r:1,c:2}] }, // T-shape, size 4
        { name: "Cirkáló", id: 'cruiser', shape: [{r:0,c:0},{r:1,c:0},{r:2,c:0}] }, // I-shape, size 3
        { name: "Tengeralattjáró", id: 'submarine', shape: [{r:0,c:0},{r:1,c:0},{r:1,c:1}] }, // small L-shape, size 3
        { name: "Romboló", id: 'destroyer', shape: [{r:0,c:0},{r:0,c:1}] }, // I-shape, size 2
        { name: "Aknaszedő", id: 'minesweeper', shape: [{r:0,c:0},{r:1,c:1}] }, // Diagonal, size 2
        { name: "Motorcsónak", id: 'speedboat', shape: [{r:0,c:0}] } // 1x1, size 1
    ];

    const prizeTypes = [ { name: "Gumicsirke", id: 'chicken', value: 15000 }, { name: "Lyukas Gumicsónak", id: 'boat', value: 25000 }, { name: "A Szomszéd Macskája", id: 'cat', value: 40000 }, { name: "Egy Csomag Ropi", id: 'ropi', value: 10000 } ];

    // --- DOM Elements ---
    const gameBoardEl = document.getElementById('game-board'), boardMessageOverlayEl = document.getElementById('board-message-overlay'), prizeModal = document.getElementById('prize-modal'), grandPrizeModal = document.getElementById('grand-prize-modal'), temptationModal = document.getElementById('temptation-modal'), outOfAmmoModal = document.getElementById('out-of-ammo-modal'), shotsEl = document.querySelector('#shots-stat p'), scoreEl = document.querySelector('#score-stat p'), premiumEl = document.querySelector('#premium-stat p'), premiumStatEl = document.getElementById('premium-stat'), shipsLeftEl = document.querySelector('#ships-left-stat p'), fleetListEl = document.getElementById('fleet-list'), prizeListEl = document.getElementById('prize-list'), newGameButton = document.getElementById('new-map-button'), waitingPanel = document.getElementById('waiting-panel'), waitingTimeEl = document.getElementById('waiting-time'), waitingScoreEl = document.getElementById('waiting-score'), liveTimeWaitingEl = document.getElementById('live-time-waiting'), openBuyShotsBtn = document.getElementById('open-buy-shots-modal'), buySonarBtn = document.getElementById('buy-sonar'), buyStrikeBtn = document.getElementById('buy-strike'), useSonarBtn = document.getElementById('use-sonar'), useStrikeBtn = document.getElementById('use-strike'), sonarChargesBadge = document.getElementById('sonar-charges-badge'), strikeChargesBadge = document.getElementById('strike-charges-badge');
    const buyAmmoModal = document.getElementById('buy-ammo-modal'), ammoQuantityInput = document.getElementById('ammo-quantity'), ammoTotalCostEl = document.getElementById('ammo-total-cost'), buyAmmoConfirmBtn = document.getElementById('btn-buy-ammo-confirm');
    
    // --- Icons ---
    const icons = { miss: document.getElementById('miss-svg'), hit: document.getElementById('hit-svg'), prize: document.getElementById('prize-svg') };
    
    // --- Game State ---
    let boardState, ships, boardPrizes, shots, roundMoney, premiumShots, gameOver, currentMapSeed, seededRandom;
    let totalMoney = 0;
    let playerInventory = [];
    let gameInProgress = false;
    let playerSonarCharges = 0, playerStrikeCharges = 0;
    let messageTimeout;

    // --- Core Functions ---
    const mulberry32 = (a) => () => { let t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; };
    
    // --- Persistence ---
    function saveState() { const gameState = { totalMoney: totalMoney + roundMoney, inventory: playerInventory, lastMapSeed: currentMapSeed, sonar: playerSonarCharges, strike: playerStrikeCharges }; localStorage.setItem('globalTorpedoSave', JSON.stringify(gameState)); }
    function loadState() { const savedState = localStorage.getItem('globalTorpedoSave'); if (savedState) { const data = JSON.parse(savedState); totalMoney = data.totalMoney || 0; playerInventory = data.inventory || []; playerSonarCharges = data.sonar || 0; playerStrikeCharges = data.strike || 0; } }

    // --- Game Initialization ---
    function initGame() {
        currentMapSeed = Math.floor(Date.now() / MAP_REFRESH_INTERVAL);
        const savedState = JSON.parse(localStorage.getItem('globalTorpedoSave'));
        if (savedState && savedState.lastMapSeed === currentMapSeed) { showWaitingScreen(); return; }
        seededRandom = mulberry32(currentMapSeed);
        shots = 30; roundMoney = 0; premiumShots = 0; gameOver = false; gameInProgress = true;
        boardState = Array(boardSize).fill(null).map(() => Array(boardSize).fill(null).map(() => ({ shipId: null, prizeId: null, state: 'empty' })));
        displayMessage("Kezdődjön a csata!", 3000);
        newGameButton.style.display = 'none'; waitingPanel.style.display = 'none'; gameBoardEl.style.display = 'table'; document.getElementById('stats-panel').style.display = 'flex';
        placeShips(); placePrizes(); renderBoard(); renderFleetStatus(); renderPrizeList(); updateStats();
    }
    
    function showWaitingScreen() {
        gameInProgress = false;
        gameBoardEl.style.display = 'none'; document.getElementById('stats-panel').style.display = 'none'; newGameButton.style.display = 'none'; waitingPanel.style.display = 'block';
        updateStats();
    }

    // --- Shape Transformation Logic ---
    function normalizeShape(shape) {
        const minR = Math.min(...shape.map(p => p.r));
        const minC = Math.min(...shape.map(p => p.c));
        return shape.map(p => ({ r: p.r - minR, c: p.c - minC }));
    }

    function getShapeTransformations(shape) {
        const transformations = new Set();
        let currentShape = shape;
        for (let i = 0; i < 4; i++) {
            currentShape = normalizeShape(currentShape.map(p => ({ r: -p.c, c: p.r })));
            transformations.add(JSON.stringify(currentShape.sort((a,b) => a.r - b.r || a.c - b.c)));
        }
        currentShape = normalizeShape(shape.map(p => ({ r: p.r, c: -p.c })));
        for (let i = 0; i < 4; i++) {
            currentShape = normalizeShape(currentShape.map(p => ({ r: -p.c, c: p.r })));
            transformations.add(JSON.stringify(currentShape.sort((a,b) => a.r - b.r || a.c - b.c)));
        }
        return Array.from(transformations, s => JSON.parse(s));
    }

    // --- Placement Logic ---
    function placeShips() {
        ships = [];
        shipTypes.forEach(shipType => {
            const allOrientations = getShapeTransformations(shipType.shape);
            let placed = false;
            while (!placed) {
                const orientation = allOrientations[Math.floor(seededRandom() * allOrientations.length)];
                const shapeWidth = Math.max(...orientation.map(p => p.c)) + 1;
                const shapeHeight = Math.max(...orientation.map(p => p.r)) + 1;
                const sr = Math.floor(seededRandom() * (boardSize - shapeHeight + 1));
                const sc = Math.floor(seededRandom() * (boardSize - shapeWidth + 1));

                if (isValidPlacement(orientation, sr, sc)) {
                    const coords = [];
                    orientation.forEach(part => {
                        const r = sr + part.r;
                        const c = sc + part.c;
                        boardState[r][c].shipId = shipType.id;
                        coords.push({ row: r, col: c });
                    });
                    ships.push({ ...shipType, size: shipType.shape.length, coords, hits: 0, sunk: false });
                    placed = true;
                }
            }
        });
    }

    function isValidPlacement(shape, startRow, startCol) {
        for (const part of shape) {
            const r = startRow + part.r;
            const c = startCol + part.c;
            if (r < 0 || r >= boardSize || c < 0 || c >= boardSize) return false;
            for (let dr = -1; dr <= 1; dr++) {
                for (let dc = -1; dc <= 1; dc++) {
                    const checkR = r + dr;
                    const checkC = c + dc;
                    if (checkR >= 0 && checkR < boardSize && checkC >= 0 && checkC < boardSize) {
                        if (boardState[checkR][checkC].shipId !== null) { return false; }
                    }
                }
            }
        }
        return true;
    }
    
    function placePrizes() {
        boardPrizes = [];
        prizeTypes.forEach(prize => {
            let placed = false;
            while (!placed) {
                const r = Math.floor(seededRandom() * boardSize);
                const c = Math.floor(seededRandom() * boardSize);
                let valid = true;
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                         const checkR = r + dr;
                         const checkC = c + dc;
                         if (checkR >= 0 && checkR < boardSize && checkC >= 0 && checkC < boardSize) {
                            if(boardState[checkR][checkC].shipId !== null || boardState[checkR][checkC].prizeId !== null) {
                                valid = false; break;
                            }
                         }
                    }
                    if(!valid) break;
                }
                if (valid) {
                    boardState[r][c].prizeId = prize.id;
                    boardPrizes.push({ ...prize });
                    placed = true;
                }
            }
        });
    }
    
    // --- Rendering ---
    function renderBoard() { gameBoardEl.innerHTML = `<tr><th></th>${Array.from({length:10}, (_,i)=>`<th>${String.fromCharCode(65+i)}</th>`).join('')}</tr>`; for (let i = 0; i < boardSize; i++) { const rowEl = gameBoardEl.insertRow(); rowEl.innerHTML = `<th>${i + 1}</th>`; for (let j = 0; j < boardSize; j++) { const cellEl = rowEl.insertCell(); cellEl.dataset.row = i; cellEl.dataset.col = j; cellEl.addEventListener('click', handleCellClick); } } }
    function renderFleetStatus() { fleetListEl.innerHTML = ships.sort((a,b) => b.size - a.size).map(ship => `<li id="fleet-${ship.id}" class="${ship.sunk ? 'sunk' : ''}">${ship.name} (${ship.size})</li>`).join(''); }
    
    function renderPrizeList() {
        prizeListEl.innerHTML = playerInventory.length ? playerInventory.map(p => { const currentValue = Math.floor(p.value * (1 + 0.25 * (p.heldRounds || 0))); return `<li><span>${p.name}</span><button class="sell-prize-btn" data-prize-id="${p.id}">Eladom (${currentValue.toLocaleString()} Ft)</button></li>`}).join('') : '<li>Még nincs zsákmányod</li>';
        document.querySelectorAll('.sell-prize-btn').forEach(btn => btn.addEventListener('click', handleSellPrize));
    }

    // --- Gameplay Handlers ---
    function handleSellPrize(e) { const prizeId = e.target.dataset.prizeId; const prizeIndex = playerInventory.findIndex(p => p.id === prizeId); if (prizeIndex > -1) { const soldPrize = playerInventory.splice(prizeIndex, 1)[0]; const currentValue = Math.floor(soldPrize.value * (1 + 0.25 * (soldPrize.heldRounds || 0))); totalMoney += currentValue; displayMessage(`${soldPrize.name} eladva!`, 2000); renderPrizeList(); updateStats(); saveState(); } }
    
    function handleCellClick(e) {
        if (gameOver || !gameInProgress) return;
        const targetCell = e.target.closest('td'); if (!targetCell) return;
        const row = parseInt(targetCell.dataset.row), col = parseInt(targetCell.dataset.col);
        const cellState = boardState[row][col];
        if (cellState.state !== 'empty') return;
        if(shots <= 0 && premiumShots <= 0) { showOutOfAmmoModal(); return; }
        
        const isPremiumShot = premiumShots > 0;
        targetCell.classList.add('shot');
        
        if (cellState.shipId) {
            if (!isPremiumShot) { shots--; }
            handleHit(targetCell, isPremiumShot);
        } else {
            if (isPremiumShot) { premiumShots--; } 
            else { shots--; }
            if (cellState.prizeId) { handlePrize(targetCell); } 
            else { handleMiss(targetCell); }
        }
        updateStats();
        checkGameOver();
    }

    function handleHit(cellEl, wasPremium) { const row = cellEl.dataset.row, col = cellEl.dataset.col; boardState[row][col].state = 'hit'; cellEl.classList.add('hit'); const icon = icons.hit.cloneNode(true); icon.classList.add('icon'); cellEl.appendChild(icon); roundMoney += wasPremium ? 2500 : 500; premiumShots += 1; displayMessage(`TALÁLAT!`, 1500, () => displayMessage("PRÉMIUM LÖVÉS!", 1500)); const hitShip = ships.find(ship => ship.id === boardState[row][col].shipId); hitShip.hits++; if (hitShip.hits === hitShip.size) handleSunkShip(hitShip); }
    function handlePrize(cellEl) { cellEl.classList.add('prize'); const icon = icons.prize.cloneNode(true); icon.classList.add('icon'); cellEl.appendChild(icon); const prize = prizeTypes.find(p => p.id === boardState[cellEl.dataset.row][cellEl.dataset.col].prizeId); showPrizeModal(prize); }
    function handleMiss(cellEl) { cellEl.classList.add('miss'); const icon = icons.miss.cloneNode(true); icon.classList.add('icon'); cellEl.appendChild(icon); displayMessage("MELLÉ!", 1500); }
    function handleSunkShip(sunkShip) { sunkShip.sunk = true; roundMoney += 10000; displayMessage(`${sunkShip.name} elsüllyedt!`, 3000); sunkShip.coords.forEach(({ row, col }) => { gameBoardEl.querySelector(`[data-row='${row}'][data-col='${col}']`).classList.add('sunk'); }); renderFleetStatus(); }
    
    // --- Modals and Game Over ---
    function showPrizeModal(prize) { gameOver = true; document.getElementById('prize-name').textContent = prize.name; document.getElementById('btn-collect-points').textContent = `${prize.value.toLocaleString()} Ft-ért eladom`; const collectHandler = () => { playerInventory.push({ ...prize, heldRounds: 0 }); renderPrizeList(); closePrizeModal(); saveState(); }; const cashHandler = () => { roundMoney += prize.value; closePrizeModal(); }; document.getElementById('btn-collect-prize').onclick = collectHandler; document.getElementById('btn-collect-points').onclick = cashHandler; prizeModal.classList.add('visible'); }
    function closePrizeModal() { prizeModal.classList.remove('visible'); gameOver = false; updateStats(); }
    function checkGameOver() { if (!gameOver && ships.every(ship => ship.sunk)) { gameOver = true; premiumShots = 0; updateStats(); setTimeout(startGrandPrizeGame, 1500); } }
    function endGameNoAmmo() { gameOver = true; totalMoney += roundMoney; roundMoney = 0; displayMessage("VÉGE A JÁTÉKNAK!", 5000); updateStats(); saveState(); setTimeout(showWaitingScreen, 3000); }
    function showOutOfAmmoModal() { /* Full function as before */ }
    function startGrandPrizeGame() { /* Full function as before */ }

    // --- UI and Stats ---
    function updateStats() { const shipsRemaining = ships ? ships.filter(s => !s.sunk).length : 0; const shipsTotal = ships ? ships.length : 7; const currentMoney = totalMoney + roundMoney; shotsEl.textContent = shots; scoreEl.textContent = `${currentMoney.toLocaleString()} Ft`; premiumEl.textContent = premiumShots; shipsLeftEl.textContent = `${shipsRemaining}/${shipsTotal}`; premiumStatEl.classList.toggle('active', premiumShots > 0 && !gameOver); buySonarBtn.disabled = currentMoney < PRICES.sonar; buyStrikeBtn.disabled = currentMoney < PRICES.strike; openBuyShotsBtn.disabled = currentMoney < PRICES.shot; sonarChargesBadge.textContent = playerSonarCharges; strikeChargesBadge.textContent = playerStrikeCharges; useSonarBtn.disabled = playerSonarCharges <= 0; useStrikeBtn.disabled = playerStrikeCharges <= 0; waitingScoreEl.textContent = `${(totalMoney + roundMoney).toLocaleString()} Ft`; }
    function displayMessage(text, duration = 2000, callback) { clearTimeout(messageTimeout); const overlay = boardMessageOverlayEl; overlay.textContent = text; overlay.style.animation = 'none'; overlay.offsetHeight; overlay.style.animation = `fade-in-out-zoom ${duration / 1000}s ease-in-out forwards`; messageTimeout = setTimeout(() => { if (callback) callback(); }, duration); }
    
    // --- Shop and Arsenal ---
    function purchase(cost, callback) { if (totalMoney + roundMoney >= cost) { let rem = cost; if (roundMoney > 0) { const fromRound = Math.min(roundMoney, rem); roundMoney -= fromRound; rem -= fromRound; } if (rem > 0) { totalMoney -= rem; } callback(); updateStats(); saveState(); } else { displayMessage("Nincs elég pénzed!", 2000); } }
    function updateAmmoCost() { const quantity = parseInt(ammoQuantityInput.value) || 0; if (quantity < 1) { ammoQuantityInput.value = 1; return; } const totalCost = quantity * PRICES.shot; ammoTotalCostEl.textContent = `${totalCost.toLocaleString()} Ft`; buyAmmoConfirmBtn.disabled = totalCost > (totalMoney + roundMoney); }
    ammoQuantityInput.addEventListener('input', updateAmmoCost);
    openBuyShotsBtn.addEventListener('click', () => { buyAmmoModal.classList.add('visible'); updateAmmoCost(); });
    document.getElementById('btn-buy-ammo-cancel').addEventListener('click', () => buyAmmoModal.classList.remove('visible'));
    buyAmmoConfirmBtn.addEventListener('click', () => { const quantity = parseInt(ammoQuantityInput.value); const totalCost = quantity * PRICES.shot; purchase(totalCost, () => { shots += quantity; displayMessage(`+${quantity} Lőszer`, 2000); buyAmmoModal.classList.remove('visible'); }); });
    buySonarBtn.addEventListener('click', () => purchase(PRICES.sonar, () => { playerSonarCharges++; displayMessage("+1 Szónár", 2000); }));
    buyStrikeBtn.addEventListener('click', () => purchase(PRICES.strike, () => { playerStrikeCharges++; displayMessage("+1 Célzott Csapás", 2000); }));
    useSonarBtn.addEventListener('click', () => { if(playerSonarCharges > 0) { playerSonarCharges--; displayMessage("SZÓNÁR BEVETVE!", 4000); updateStats(); saveState(); } }); 
    useStrikeBtn.addEventListener('click', () => { if(playerStrikeCharges > 0) { playerStrikeCharges--; displayMessage("CÉLZOTT CSAPÁS!", 2000); updateStats(); saveState(); } }); 

    // --- Time Management ---
    function tick() {
        const now = new Date(); const millis = now.getTime();
        liveTimeWaitingEl.textContent = now.toLocaleTimeString('hu-HU');
        const nextMapTimestamp = (Math.floor(millis / MAP_REFRESH_INTERVAL) + 1) * MAP_REFRESH_INTERVAL;
        const nextMapDate = new Date(nextMapTimestamp);
        const timeString = nextMapDate.toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' });
        waitingTimeEl.textContent = `${timeString}-kor`;
        const newSeed = Math.floor(millis / MAP_REFRESH_INTERVAL);
        if (newSeed > currentMapSeed) {
            if (gameInProgress && !gameOver) { newGameButton.style.display = 'block'; } 
            else if(!gameInProgress) { startNewRound(); }
        }
    }

    function startNewRound() {
        totalMoney += roundMoney; roundMoney = 0;
        playerInventory.forEach(p => p.heldRounds = (p.heldRounds || 0) + 1);
        saveState(); initGame();
    }

    // --- Initial Load ---
    window.addEventListener('beforeunload', saveState);
    newGameButton.addEventListener('click', startNewRound);
    loadState();
    setInterval(tick, 1000);
    initGame();
});
</script>
</body>
</html>
