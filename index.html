<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Globális Torpedó</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@800&family=Poppins:wght@400;600&display=swap');

        :root {
            --cell-bg: rgba(255, 255, 255, 0.05); 
            --cell-border: #8e9eab;
            --text-color: #E0E5EC; --hit-color: #ff4757; --miss-color: #537895;
            --sunk-color: #343a40; --prize-color: #feca57; --premium-glow: #ffd700;
        }

        body {
            font-family: 'Poppins', sans-serif; display: flex; align-items: center; justify-content: center;
            min-height: 100vh; color: var(--text-color); margin: 0; padding: 20px; box-sizing: border-box;
            background-image: linear-gradient(to bottom, rgba(9, 20, 27, 0.85), rgba(15, 32, 39, 0.9)), url('https://images.pexels.com/photos/220201/pexels-photo-220201.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2');
            background-size: cover; background-position: center center; background-attachment: fixed; background-repeat: no-repeat;
        }

        #game-container {
            width: 100%; max-width: 950px; 
            background: transparent;
            padding: 0;
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr 260px;
            grid-template-areas: "main side";
        }

        #main-panel { grid-area: main; min-width: 320px; display: flex; flex-direction: column; gap: 20px; }
        #side-panel { grid-area: side; width: 260px; flex-shrink: 0; display: flex; flex-direction: column; gap: 20px;}

        #game-header { text-align: center; }
        #game-header h1 {
            font-family: 'Orbitron', sans-serif; font-size: clamp(2.5rem, 8vw, 4rem); color: white;
            margin: 0; text-shadow: 0 0 10px var(--cell-border), 0 0 20px var(--cell-border);
        }
        
        #stats-panel { display: flex; justify-content: space-around; gap: 5px; text-align: center; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 15px; border: 1px solid rgba(142, 158, 171, 0.5); }
        .stat { background: none; border: none; padding: 5px; }
        .stat h3 { margin: 0; font-size: 0.7em; color: var(--cell-border); text-transform: uppercase; font-weight: 400; }
        .stat p { margin: 2px 0 0 0; font-size: 1.2em; font-weight: 600; font-family: 'Orbitron'; }
        #premium-stat.active p { color: var(--premium-glow); animation: pulse 1.5s infinite; }

        #player-controls { display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        .player-info { font-size: 1.1em; font-weight: 600; transition: all 0.3s ease; cursor: pointer; padding: 5px 10px; border: 2px solid transparent; border-radius: 10px; }
        .player-info.active { color: var(--premium-glow); transform: scale(1.1); text-shadow: 0 0 8px var(--premium-glow); }
        .player-info.locked { border-color: var(--premium-glow); box-shadow: 0 0 10px var(--premium-glow); }
        .lock-icon { margin-left: 5px; }
        #rename-players-btn { background-color: var(--cell-bg); border: 1px solid var(--cell-border); color: var(--text-color); padding: 8px 15px; border-radius: 10px; cursor: pointer; font-family: 'Poppins'; font-weight: 600; transition: all 0.2s; }
        #rename-players-btn:hover { background-color: rgba(142, 158, 171, 0.4); }

        #board-wrapper { position: relative; }
        .board-locked #game-board td:not(.shot) { cursor: not-allowed !important; }
        .board-locked #game-board td:not(.shot):hover { background-color: transparent; transform: none; }
        
        #board-message-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Orbitron', sans-serif; font-size: clamp(1.8rem, 8vw, 3rem);
            color: var(--premium-glow); text-shadow: 0 0 10px #000, 0 0 20px var(--premium-glow);
            pointer-events: none; opacity: 0; z-index: 10;
            text-align: center; text-transform: uppercase;
            line-height: 1.2;
        }

        #game-board { border-collapse: separate; border-spacing: 4px; margin: 0 auto; }
        #game-board th, #game-board td { width: clamp(28px, 6.5vw, 40px); height: clamp(28px, 6.5vw, 40px); text-align: center; font-family: 'Orbitron'; color: var(--cell-border); vertical-align: middle; user-select: none; }
        #game-board th { background: rgba(255, 255, 255, 0.03); border-radius: 8px; }
        #game-board td { background: transparent; border: 2px solid var(--cell-border); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; position: relative; }
        #game-board td:hover:not(.shot) { background-color: rgba(142, 158, 171, 0.3); transform: scale(1.05); }
        #game-board td.shot { cursor: not-allowed; } #game-board td.shot:hover { transform: none; }
        #game-board td.miss { background-color: var(--miss-color); }
        #game-board td.hit { background-color: var(--hit-color); animation: hit-shake 0.5s; }
        #game-board td.sunk { animation: sink-animation 1s forwards; }
        #game-board td.prize { background-color: var(--prize-color); border-color: #FFF; box-shadow: 0 0 15px var(--prize-color); }
        
        #waiting-panel { display: none; text-align: center; padding: 20px; background: rgba(9, 20, 27, 0.9); border: 1px solid var(--premium-glow); border-radius: 20px; }
        #waiting-title { font-family: 'Orbitron'; font-size: 2em; color: var(--premium-glow); margin-bottom: 10px; }
        #waiting-info { font-family: 'Poppins'; font-size: 1.2em; margin: 15px 0; color: white; }
        #waiting-time, #waiting-score, #live-time-waiting { font-family: 'Orbitron'; font-size: 1.5em; color: var(--premium-glow); }
        #waiting-player-scores { margin-top: 15px; font-size: 1.1em; line-height: 1.5; }
        #rules-container { text-align: left; font-size: 0.9em; padding: 15px; border-top: 1px solid var(--cell-border); margin-top: 15px; }
        #rules-container h3 { color: var(--premium-glow); border-bottom: 1px solid var(--premium-glow); padding-bottom: 5px; margin-top: 0; }
        #rules-container ul { padding-left: 20px; margin: 10px 0 0 0; }
        #rules-container li { margin-bottom: 8px; }

        .icon { width: 70%; height: 70%; vertical-align: middle; position: absolute; top: 15%; left: 15%; }
        
        .side-box { background: rgba(0,0,0,0.25); border: 1px solid var(--cell-border); border-radius: 15px; padding: 15px; }
        .side-box h2 { font-family: 'Orbitron'; text-align: center; color: var(--cell-border); border-bottom: 2px solid var(--cell-border); padding-bottom: 5px; margin-top: 0; font-size: 1.2em; }
        #fleet-list, #prize-list { list-style: none; padding: 0; margin: 0; }
        #fleet-list li, #prize-list li { background: var(--cell-bg); padding: 8px; border-radius: 8px; margin-bottom: 8px; font-weight: 600; transition: all 0.3s; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
        #fleet-list li.sunk { background-color: var(--sunk-color); color: #999; text-decoration: line-through; border: 1px solid #555; }
        .sunk-by-player { font-size: 0.8em; color: var(--premium-glow); margin-left: 5px; font-weight: bold; }
        
        #new-map-button { display: none; width: 100%; margin-top: 15px; padding: 12px; font-size: 1em; font-weight: 700; font-family: 'Orbitron'; color: #000; background-color: var(--premium-glow); border: none; border-radius: 15px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 0 20px var(--premium-glow); }
        #new-map-button:hover { transform: scale(1.05); }
        
        #shop-items button, .sell-prize-btn { padding: 10px; margin-bottom: 8px; background-color: var(--cell-bg); border: 1px solid var(--cell-border); color: var(--text-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .shop-item { position: relative; margin-bottom: 12px; }
        .shop-item button { width: 100%; margin: 0; }
        .item-badge { position: absolute; top: -5px; right: -5px; background-color: var(--premium-glow); color: #000; border-radius: 50%; width: 22px; height: 22px; line-height: 22px; text-align: center; font-weight: bold; font-size: 0.9em; box-shadow: 0 0 10px var(--premium-glow); }
        .sell-prize-btn { font-size: 0.8em; padding: 4px 8px; margin: 0; background-color: var(--premium-glow); color: #000; font-weight: bold; }
        #shop-items button:hover:not(:disabled), .sell-prize-btn:hover { background-color: rgba(142, 158, 171, 0.4); }
        #shop-items button:disabled { cursor: not-allowed; opacity: 0.5; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content { background: linear-gradient(145deg, #232526, #414345); border: 2px solid var(--premium-glow); border-radius: 20px; padding: 30px; text-align: center; color: white; width: 90%; max-width: 650px; transform: scale(0.9); transition: transform 0.3s; box-shadow: 0 0 30px var(--premium-glow); }
        .modal.visible .modal-content { transform: scale(1); }
        .modal-content h2 { font-family: 'Orbitron'; margin-top: 0; font-size: 2.2em; text-shadow: 0 0 10px var(--premium-glow); } 
        .modal-content p { font-size: 1.1em; }
        .modal-buttons { display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap; justify-content: center; }
        .modal-buttons button { flex-grow: 1; padding: 12px; font-size: 1em; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: transform 0.2s; min-width: 150px; }
        .modal-buttons button:hover { transform: scale(1.05); }
        .btn-confirm { background-color: var(--premium-glow); color: #000; } .btn-cancel { background-color: var(--sunk-color); color: #fff; }
        
        .quantity-control { display: flex; justify-content: center; align-items: center; gap: 10px; }
        .quantity-control button { font-family: 'Orbitron'; font-size: 1.5em; width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--cell-border); background-color: var(--cell-bg); color: white; cursor: pointer; }
        .modal-content input[type=number] { width: 80px; padding: 8px; text-align: center; background: var(--cell-bg); border: 1px solid var(--cell-border); color: white; border-radius: 8px; font-size: 1.2em; font-family: 'Orbitron'; -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        #grand-prize-ships { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 20px; perspective: 1000px; }
        .ship-choice { background: none; border: none; cursor: pointer; padding: 0; }
        .flipper { position: relative; width: 100px; height: 100px; transition: transform 0.8s; transform-style: preserve-3d; }
        .ship-choice.is-flipped .flipper { transform: rotateY(180deg); }
        .front, .back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; flex-direction: column; border-radius: 15px; border: 2px solid var(--cell-border); }
        .front { background: rgba(0,0,0,0.3); }
        .back { transform: rotateY(180deg); font-family: 'Orbitron'; font-size: 1.3em; padding: 5px; line-height: 1.2; text-align: center; }
        .back.bankrupt { background: #4d0000; text-shadow: 0 0 10px #000; font-size: 1.2em; }
        .back.sunk { background: #8B0000; text-shadow: 0 0 10px #000; }
        .back.safe { background: #003366; text-shadow: 0 0 10px #fff; }
        .back.double { background: #006400; text-shadow: 0 0 10px #fff; }
        .back.triple { background: var(--premium-glow); color: #000; text-shadow: 0 0 10px #fff; }
        .back.money { background: #4682B4; }
        .back.aid { background: #6a0dad; }
        
        .front svg { width: 70px; height: 70px; fill: var(--cell-border); transition: all 0.3s ease; }
        .ship-choice:hover:not(:disabled) .front svg { fill: var(--premium-glow); transform: scale(1.1); }
        #grand-prize-result { margin-top: 20px; height: 50px; font-size: 1.2em; font-weight: bold; }

        @keyframes pulse { 50% { text-shadow: 0 0 15px var(--premium-glow); } }
        @keyframes hit-shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes sink-animation { 0% { background-color: var(--hit-color); transform: scale(1.1); border-color: white; } 50% { background-color: var(--hit-color); transform: scale(0.8); opacity: 0.8; } 100% { background-color: var(--sunk-color); transform: scale(1); opacity: 0.6; border-color: var(--sunk-color); } }
        @keyframes fade-in-out-zoom { 0% { transform: scale(0.8); opacity: 0; } 15% { transform: scale(1.1); opacity: 1; } 85% { transform: scale(1); opacity: 1; } 100% { transform: scale(0.9); opacity: 0; } }
        
        @media (min-width: 901px) {
            #main-panel > #prize-corner {
                max-width: 480px; /* Aligns with the game board width (10*40px + 9*4px + borders) approx */
                margin-left: auto;
                margin-right: auto;
                margin-top: 0;
            }
        }
        @media (max-width: 900px) {
            body { padding: 10px; }
            #game-container {
                display: flex;
                flex-direction: column;
                grid-template-columns: 1fr;
                grid-template-areas: "main" "side";
            }
            #main-panel { order: 1; }
            #side-panel { 
                order: 2; 
                width: 100%;
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 15px;
            }
            .side-box {
                flex-grow: 1;
                min-width: calc(50% - 10px);
            }
            #prize-corner { display: block; order: initial; } /* Reset order for mobile */
            #new-map-button { order: 3; }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="main-panel">
            <div id="game-header"><h1>Globális Torpedó</h1></div>
            <div id="stats-panel">
                <div id="shots-stat" class="stat"><h3>Lőszer</h3><p>60</p></div>
                <div id="score-stat" class="stat"><h3>Kassza</h3><p>0 Ft</p></div>
                <div id="premium-stat" class="stat"><h3>Prémium</h3><p>0</p></div>
                <div id="ships-left-stat" class="stat"><h3>Hajók</h3><p>7</p></div>
            </div>
            <div id="player-controls">
                <span id="player1-info" class="player-info"></span>
                <button id="rename-players-btn">Nevek Módosítása</button>
                <span id="player2-info" class="player-info"></span>
            </div>
            <div id="board-wrapper">
                <div id="board-message-overlay"></div>
                <table id="game-board"></table>
            </div>
            <div id="prize-corner" class="side-box">
                <h2>Zsákmány</h2><ul id="prize-list"></ul>
            </div>
            <div id="waiting-panel">
                <h2 id="waiting-title">PIHENŐ A FEDÉLZETEN</h2>
                <div id="waiting-info">
                    <p>Aktuális idő: <span id="live-time-waiting"></span></p>
                    <p>Aktuális vagyon: <span id="waiting-score">0 Ft</span></p>
                    <p>A következő portya indul: <span id="waiting-time">00:00-kor</span></p>
                </div>
                <div id="waiting-player-scores">
                    <h3>Előző kör pontjai</h3>
                    <span id="waiting-player1-score"></span><br>
                    <span id="waiting-player2-score"></span>
                </div>
                <div id="rules-container">
                    <h3>Játékszabályzat és Segítség</h3>
                    <ul>
                        <li><strong>Cél:</strong> Süllyeszd el az összes (7) ellenséges hajót a pályán.</li>
                        <li><strong>Pontozás:</strong> Minden elsüllyesztett hajó **1 pontot** ér, plusz **további annyi pontot, ahány egységből állt** a hajó (pl. egy 4-es hajó 1+4=5 pontot ér).</li>
                        <li><strong>Játékmenet:</strong> Találat után a játékos újra lőhet. Ha nem talál, a másik játékos következik.</li>
                        <li><strong>Lőszer:</strong> 60 lövéssel kezdesz. Ha elfogy, az Arzenálban vásárolhatsz.</li>
                        <li><strong>Találati Lánc:</strong> Minden találatért +1 prémium lövést kapsz. A prémium lövés csak akkor fogy el, ha mellélősz.</li>
                        <li><strong>Nyereménytárgyak:</strong> Körönként 5 véletlenszerű zsákmány van a pályán. Megtarthatod őket, hogy az értékük minden új körrel <strong>25%-kal nőjön!</strong></li>
                        <li><strong>Fődíj Játék:</strong> A győztes kör végén válassz egyet a 10 hajó közül a végső jutalomért!</li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="side-panel">
            <div id="shop" class="side-box">
                <h2>Arzenál</h2>
                <div id="shop-items">
                    <div class="shop-item"><button id="use-sonar">Szónár Bevetése</button><div class="item-badge" id="sonar-charges-badge">0</div></div>
                    <div class="shop-item"><button id="use-strike">Célzott Csapás</button><div class="item-badge" id="strike-charges-badge">0</div></div>
                    <hr style="border-color: var(--cell-border); margin: 15px 0;">
                    <button id="buy-sonar">+1 Szónár (200 000 Ft)</button>
                    <button id="buy-strike">+1 Csapás (500 000 Ft)</button>
                    <button id="open-buy-shots-modal">Lőszer Vásárlása</button>
                </div>
            </div>
            <div id="fleet-status" class="side-box">
                <h2>Flotta</h2><ul id="fleet-list"></ul>
            </div>
            <button id="new-map-button">Új Vizekre, Kapitány!</button>
        </div>
    </div>
    
    <div id="prize-modal" class="modal"><div class="modal-content"><h2>NYEREMÉNYTÁRGY!</h2><p>Eltaláltad ezt: <strong id="prize-name"></strong>!</p><p>Mit választasz?</p><div class="modal-buttons"><button id="btn-collect-prize" class="btn-cancel">Megtartom</button><button id="btn-collect-points" class="btn-confirm"></button></div></div></div>
    <div id="grand-prize-modal" class="modal"><div class="modal-content"><h2>FŐDÍJ JÁTÉK!</h2><p>Válassz egyet a hadihajók közül a végső jutalomért! A szerencse a bátraknak kedvez...</p><div id="grand-prize-ships"></div><div id="grand-prize-result"></div><div class="modal-buttons" style="margin-top: 15px;"><button id="btn-close-grand-prize" class="btn-confirm" style="display:none;">Rendben</button></div></div></div>
    <div id="temptation-modal" class="modal"><div class="modal-content"><h2>EGY AJÁNLAT...</h2><p id="temptation-text"></p><div class="modal-buttons"><button id="btn-reject-offer" class="btn-cancel">NEM, MARADOK!</button><button id="btn-accept-offer" class="btn-confirm">IGEN, CSERÉLEK!</button></div></div></div>
    <div id="out-of-ammo-modal" class="modal"><div class="modal-content"><h2>VÉSZHELYZET A FEDÉLZETEN!</h2><p id="ammo-modal-text">Kapitány, kifogytunk a lőszerből! Mit tegyünk?</p><div class="modal-buttons"><button id="btn-ammo-buy" class="btn-confirm">Lőszer Vásárlása</button><button id="btn-ammo-sell" class="btn-confirm">Zsákmány Beváltása</button><button id="btn-ammo-end" class="btn-cancel">Harci Álláspont Elhagyása</button></div></div></div>
    <div id="buy-ammo-modal" class="modal"><div class="modal-content"><h2>Lőszer Vásárlása</h2><p>Egy lövedék ára: 7 500 Ft.</p><div class="quantity-control"><button id="ammo-decrement-btn">-</button><input type="number" id="ammo-quantity" min="1" value="1" step="1"><button id="ammo-increment-btn">+</button></div><p style="margin-top: 20px; font-size: 1.3em;">Teljes költség: <strong id="ammo-total-cost">7 500 Ft</strong></p><div class="modal-buttons"><button id="btn-buy-ammo-confirm" class="btn-confirm">Vásárlás</button><button id="btn-buy-ammo-cancel" class="btn-cancel">Mégse</button></div></div></div>
    <div id="svg-definitions" style="display: none;"><svg id="miss-svg" viewBox="0 0 100 100"><path d="M 20 50 Q 50 20 80 50 M 30 60 Q 50 40 70 60" stroke="#FFF" stroke-width="8" fill="none" /></svg><svg id="hit-svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="25" fill="#FFF" /><circle cx="50" cy="50" r="15" fill="var(--hit-color)" /></svg><svg id="prize-svg" viewBox="0 0 24 24"><path fill="currentColor" d="M20.2,12.2C22.4,10.2 22,6.6 20,5C18.4,3.4 14.8,3 12.8,5.2L11.4,6.6L12.8,8L8,12.8L6.6,11.4L5.2,12.8C3,14.8 3.4,18.4 5,20C6.6,21.6 10.2,22 12.2,19.8L19.8,12.2M18,8.4L15.6,6L14.2,7.4L16.6,9.8L18,8.4M6,15.6L8.4,18L9.8,16.6L7.4,14.2L6,15.6M2,22L6,18L4,16L0,20V22H2M20,0H22V2L18,6L16,4L20,0M2,0H0V2L4,6L6,4L2,0Z"/></svg></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Game Config ---
    const boardSize = 10;
    const MAP_REFRESH_INTERVAL = 5 * 60 * 1000;
    const PRICES = { shot: 7500, sonar: 200000, strike: 500000 };
    
    const shipTypes = [ { name: "Hordozó", id: 'carrier', shape: [{r:0,c:0},{r:1,c:0},{r:2,c:0},{r:2,c:1},{r:2,c:2}] }, { name: "Csatahajó", id: 'battleship', shape: [{r:0,c:1},{r:1,c:0},{r:1,c:1},{r:1,c:2}] }, { name: "Cirkáló", id: 'cruiser', shape: [{r:0,c:0},{r:1,c:0},{r:2,c:0}] }, { name: "Tengeralattjáró", id: 'submarine', shape: [{r:0,c:0},{r:1,c:0},{r:1,c:1}] }, { name: "Romboló", id: 'destroyer', shape: [{r:0,c:0},{r:0,c:1}] }, { name: "Aknaszedő", id: 'minesweeper', shape: [{r:0,c:0},{r:1,c:1}] }, { name: "Motorcsónak", id: 'speedboat', shape: [{r:0,c:0}] } ];
    
    const ALL_PRIZE_TYPES = [
        { name: "Rozsdás periszkóp", id: 'periscope', value: 8000 }, { name: "Fél pár gumicsizma", id: 'boot', value: 5000 },
        { name: "Üzenet a palackban (spam)", id: 'spam_bottle', value: 2000 }, { name: "Kalózkapitány műfoga", id: 'pirate_tooth', value: 22000 },
        { name: "Ázott hajónapló", id: 'logbook', value: 12000 }, { name: "Konzerv sózott hering", id: 'herring', value: 7500 },
        { name: "Díszes horgony", id: 'anchor', value: 45000 }, { name: "Tengeri csillag", id: 'starfish', value: 9000 },
        { name: "Lyukas mentőmellény", id: 'life_vest', value: 6000 }, { name: "Cápa-riasztó spray (lejárt)", id: 'shark_spray', value: 18000 },
        { name: "A Titanic zenekarának kottája", id: 'titanic_music', value: 60000 }, { name: "Sellő fésűje", id: 'mermaid_comb', value: 35000 },
        { name: "Elveszett szemfedő", id: 'eyepatch', value: 11000 }, { name: "Kísérteties iránytű", id: 'ghost_compass', value: 28000 },
        { name: "Csillogó kagyló", id: 'shiny_shell', value: 13000 }, { name: "Bambusz horgászbot", id: 'bamboo_rod', value: 10000 },
        { name: "Polip által dedikált fotó", id: 'octopus_photo', value: 32000 }, { name: "Világítótorony villanykörtéje", id: 'lighthouse_bulb', value: 25000 },
        { name: "Davy Jones ládájának kulcsa", id: 'davy_jones_key', value: 100000 }, { name: "Aranyozott kormánykerék", id: 'gold_wheel', value: 75000 },
        { name: "Kapitányi sapka", id: 'captain_hat', value: 15000 }, { name: "Antik térkép", id: 'old_map', value: 40000 },
        { name: "Mélytengeri halászháló", id: 'fishing_net', value: 14000 }, { name: "Hajókürt", id: 'ship_horn', value: 19000 },
        { name: "Gumikacsa flotta", id: 'rubber_ducks', value: 21000 }, { name: "Víz alatti drón roncsa", id: 'drone_wreck', value: 55000 },
        { name: "Elveszett rakomány (gumicsirkék)", id: 'rubber_chicken_cargo', value: 33000 }, { name: "Tengerészgyalogos matrica", id: 'marine_sticker', value: 4000 },
        { name: "Üres rumos hordó", id: 'rum_barrel', value: 9500 }, { name: "Bálna éneke CD-n", id: 'whale_song_cd', value: 16000 },
        { name: "Vízálló kártyapakli", id: 'waterproof_cards', value: 12500 }, { name: "Zátonyra futott drón", id: 'crashed_drone', value: 29000 },
        { name: "Dekoratív hajócsavar", id: 'propeller', value: 38000 }, { name: "Kincsesláda (üres)", id: 'empty_chest', value: 17000 },
        { name: "Szuper-sós ropi", id: 'salty_pretzels', value: 5500 }, { name: "Tengeri uborka", id: 'sea_cucumber', value: 8500 },
        { name: "Viking sisak másolat", id: 'viking_helmet', value: 23000 }, { name: "Kagylókból készült nyaklánc", id: 'shell_necklace', value: 13500 },
        { name: "Nagyító", id: 'magnifying_glass', value: 7000 }, { name: "Sextáns", id: 'sextant', value: 48000 }
    ];

    // --- DOM Elements ---
    const gameBoardEl = document.getElementById('game-board'), boardWrapperEl = document.getElementById('board-wrapper'), boardMessageOverlayEl = document.getElementById('board-message-overlay'), prizeModal = document.getElementById('prize-modal'), grandPrizeModal = document.getElementById('grand-prize-modal'), temptationModal = document.getElementById('temptation-modal'), outOfAmmoModal = document.getElementById('out-of-ammo-modal'), shotsEl = document.querySelector('#shots-stat p'), scoreEl = document.querySelector('#score-stat p'), premiumEl = document.querySelector('#premium-stat p'), premiumStatEl = document.getElementById('premium-stat'), shipsLeftEl = document.querySelector('#ships-left-stat p'), fleetListEl = document.getElementById('fleet-list'), prizeListEl = document.getElementById('prize-list'), newGameButton = document.getElementById('new-map-button'), waitingPanel = document.getElementById('waiting-panel'), waitingTimeEl = document.getElementById('waiting-time'), waitingScoreEl = document.getElementById('waiting-score'), liveTimeWaitingEl = document.getElementById('live-time-waiting'), waitingPlayer1ScoreEl = document.getElementById('waiting-player1-score'), waitingPlayer2ScoreEl = document.getElementById('waiting-player2-score'), openBuyShotsBtn = document.getElementById('open-buy-shots-modal'), buySonarBtn = document.getElementById('buy-sonar'), buyStrikeBtn = document.getElementById('buy-strike'), useSonarBtn = document.getElementById('use-sonar'), useStrikeBtn = document.getElementById('use-strike'), sonarChargesBadge = document.getElementById('sonar-charges-badge'), strikeChargesBadge = document.getElementById('strike-charges-badge'), renamePlayersBtn = document.getElementById('rename-players-btn'), player1InfoEl = document.getElementById('player1-info'), player2InfoEl = document.getElementById('player2-info');
    const buyAmmoModal = document.getElementById('buy-ammo-modal'), ammoQuantityInput = document.getElementById('ammo-quantity'), ammoTotalCostEl = document.getElementById('ammo-total-cost'), buyAmmoConfirmBtn = document.getElementById('btn-buy-ammo-confirm'), ammoDecrementBtn = document.getElementById('ammo-decrement-btn'), ammoIncrementBtn = document.getElementById('ammo-increment-btn');
    const btnAmmoBuy = document.getElementById('btn-ammo-buy'), btnAmmoSell = document.getElementById('btn-ammo-sell'), btnAmmoEnd = document.getElementById('btn-ammo-end');
    
    // --- Icons ---
    const icons = { miss: document.getElementById('miss-svg'), hit: document.getElementById('hit-svg'), prize: document.getElementById('prize-svg') };
    
    // --- Game State ---
    let boardState, ships, currentRoundPrizes, shots, roundMoney, premiumShots, gameOver, currentMapSeed, seededRandom;
    let totalMoney = 0, playerInventory = [], gameInProgress = false, playerSonarCharges = 0, playerStrikeCharges = 0, messageTimeout;
    let currentPlayer = 1, player1Name = "Játékos 1", player2Name = "Játékos 2", player1Score = 0, player2Score = 0, lockedPlayer = 0;

    // --- Core Functions ---
    const mulberry32 = (a) => () => { let t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; };
    
    // --- Persistence ---
    function saveState() { const gameState = { totalMoney: totalMoney + roundMoney, inventory: playerInventory, lastMapSeed: currentMapSeed, sonar: playerSonarCharges, strike: playerStrikeCharges }; localStorage.setItem('globalTorpedoSave', JSON.stringify(gameState)); }
    function loadState() { const savedState = localStorage.getItem('globalTorpedoSave'); if (savedState) { const data = JSON.parse(savedState); totalMoney = Number(data.totalMoney) || 0; playerInventory = data.inventory || []; playerSonarCharges = Number(data.sonar) || 0; playerStrikeCharges = Number(data.strike) || 0; } }

    // --- Game Initialization ---
    function initGame() {
        currentMapSeed = Math.floor(Date.now() / MAP_REFRESH_INTERVAL);
        const savedState = JSON.parse(localStorage.getItem('globalTorpedoSave'));
        if (savedState && savedState.lastMapSeed === currentMapSeed) { showWaitingScreen(); return; }
        seededRandom = mulberry32(currentMapSeed);
        shots = 60; roundMoney = 0; premiumShots = 0; gameOver = false; gameInProgress = true;
        currentPlayer = 1; player1Score = 0; player2Score = 0; lockedPlayer = 0;
        updatePlayerUI();
        boardState = Array(boardSize).fill(null).map(() => Array(boardSize).fill(null).map(() => ({ shipId: null, prizeId: null, state: 'empty' })));
        displayMessage("Kezdődjön a csata!", 3000);
        newGameButton.style.display = 'none'; waitingPanel.style.display = 'none'; gameBoardEl.style.display = 'table'; document.getElementById('stats-panel').style.display = 'flex'; document.getElementById('player-controls').style.display = 'flex';
        const shuffledPrizes = [...ALL_PRIZE_TYPES].sort(() => 0.5 - seededRandom());
        currentRoundPrizes = shuffledPrizes.slice(0, 5);
        placeShips(); 
        placePrizes(); 
        renderBoard(); 
        renderFleetStatus(); 
        renderPrizeList(); 
        updateStats();
        handleLayout();
    }
    
    function showWaitingScreen() {
        gameInProgress = false;
        waitingPlayer1ScoreEl.textContent = `${player1Name}: ${player1Score} pont`;
        waitingPlayer2ScoreEl.textContent = `${player2Name}: ${player2Score} pont`;
        gameBoardEl.style.display = 'none'; document.getElementById('stats-panel').style.display = 'none'; document.getElementById('player-controls').style.display = 'none';
        newGameButton.style.display = 'none'; waitingPanel.style.display = 'block';
        updateStats(); handleLayout();
    }

    // --- Shape Transformation & Placement ---
    function normalizeShape(shape) { const minR = Math.min(...shape.map(p => p.r)); const minC = Math.min(...shape.map(p => p.c)); return shape.map(p => ({ r: p.r - minR, c: p.c - minC })); }
    function getShapeTransformations(shape) { const transformations = new Set(); let currentShape = shape; for (let i = 0; i < 4; i++) { currentShape = normalizeShape(currentShape.map(p => ({ r: -p.c, c: p.r }))); transformations.add(JSON.stringify(currentShape.sort((a,b) => a.r - b.r || a.c - b.c))); } currentShape = normalizeShape(shape.map(p => ({ r: p.r, c: -p.c }))); for (let i = 0; i < 4; i++) { currentShape = normalizeShape(currentShape.map(p => ({ r: -p.c, c: p.r }))); transformations.add(JSON.stringify(currentShape.sort((a,b) => a.r - b.r || a.c - b.c))); } return Array.from(transformations, s => JSON.parse(s)); }
    function placeShips() { ships = []; shipTypes.forEach(shipType => { const allOrientations = getShapeTransformations(shipType.shape); let placed = false; while (!placed) { const orientation = allOrientations[Math.floor(seededRandom() * allOrientations.length)]; const shapeWidth = Math.max(...orientation.map(p => p.c)) + 1; const shapeHeight = Math.max(...orientation.map(p => p.r)) + 1; const sr = Math.floor(seededRandom() * (boardSize - shapeHeight + 1)); const sc = Math.floor(seededRandom() * (boardSize - shapeWidth + 1)); if (isValidPlacement(orientation, sr, sc)) { const coords = []; orientation.forEach(part => { const r = sr + part.r; const c = sc + part.c; boardState[r][c].shipId = shipType.id; coords.push({ row: r, col: c }); }); ships.push({ ...shipType, size: shipType.shape.length, coords, hits: 0, sunk: false, sunkBy: null }); placed = true; } } }); }
    function isValidPlacement(shape, startRow, startCol) { for (const part of shape) { const r = startRow + part.r; const c = startCol + part.c; if (r < 0 || r >= boardSize || c < 0 || c >= boardSize) return false; for (let dr = -1; dr <= 1; dr++) { for (let dc = -1; dc <= 1; dc++) { const checkR = r + dr; const checkC = c + dc; if (checkR >= 0 && checkR < boardSize && checkC >= 0 && checkC < boardSize) { if (boardState[checkR][checkC].shipId !== null) { return false; } } } } } return true; }
    function placePrizes() { 
        currentRoundPrizes.forEach(prize => {
            let placed = false;
            while (!placed) {
                const r = Math.floor(seededRandom() * boardSize);
                const c = Math.floor(seededRandom() * boardSize);
                let valid = true;
                for (let dr = -1; dr <= 1; dr++) {
                    for (let dc = -1; dc <= 1; dc++) {
                        const checkR = r + dr;
                        const checkC = c + dc;
                        if (checkR >= 0 && checkR < boardSize && checkC >= 0 && checkC < boardSize) {
                            if(boardState[checkR][checkC].shipId !== null || boardState[checkR][checkC].prizeId !== null) {
                                valid = false; break;
                            }
                        }
                    }
                    if(!valid) break;
                }
                if (valid) {
                    boardState[r][c].prizeId = prize.id;
                    placed = true;
                }
            }
        });
    }
    
    // --- Rendering ---
    function renderBoard() { gameBoardEl.innerHTML = `<tr><th></th>${Array.from({length:10}, (_,i)=>`<th>${String.fromCharCode(65+i)}</th>`).join('')}</tr>`; for (let i = 0; i < boardSize; i++) { const rowEl = gameBoardEl.insertRow(); rowEl.innerHTML = `<th>${i + 1}</th>`; for (let j = 0; j < boardSize; j++) { const cellEl = rowEl.insertCell(); cellEl.dataset.row = i; cellEl.dataset.col = j; cellEl.addEventListener('click', handleCellClick); } } }
    function renderFleetStatus() { fleetListEl.innerHTML = ships.sort((a,b) => b.size - a.size).map(ship => { let sunkByText = ''; if (ship.sunk && ship.sunkBy) { const playerName = ship.sunkBy === 1 ? player1Name : player2Name; sunkByText = `<span class="sunk-by-player">(${playerName})</span>`; } return `<li id="fleet-${ship.id}" class="${ship.sunk ? 'sunk' : ''}"><div>${ship.name} (${ship.size})</div>${sunkByText}</li>`; }).join(''); }
    function renderPrizeList() { prizeListEl.innerHTML = playerInventory.length ? playerInventory.map(p => { const currentValue = Math.floor(p.value * (1 + 0.25 * (p.heldRounds || 0))); return `<li><span>${p.name}</span><button class="sell-prize-btn" data-prize-id="${p.id}">Eladom (${currentValue.toLocaleString()} Ft)</button></li>`}).join('') : '<li>Még nincs zsákmányod</li>'; document.querySelectorAll('.sell-prize-btn').forEach(btn => btn.addEventListener('click', handleSellPrize)); }

    // --- Gameplay Handlers ---
    function handleSellPrize(e) { const prizeId = e.target.dataset.prizeId; const prizeIndex = playerInventory.findIndex(p => p.id === prizeId); if (prizeIndex > -1) { const soldPrize = playerInventory.splice(prizeIndex, 1)[0]; const currentValue = Math.floor(soldPrize.value * (1 + 0.25 * (soldPrize.heldRounds || 0))); totalMoney += currentValue; displayMessage(`${soldPrize.name} eladva!`, 2000); renderPrizeList(); updateStats(); saveState(); } }
    function handleCellClick(e) { if (gameOver || !gameInProgress) return; if (lockedPlayer !== 0 && lockedPlayer !== currentPlayer) return; const targetCell = e.target.closest('td'); if (!targetCell) return; const row = parseInt(targetCell.dataset.row), col = parseInt(targetCell.dataset.col); const cellState = boardState[row][col]; if (cellState.state !== 'empty') return; if(shots <= 0 && premiumShots <= 0) { showOutOfAmmoModal(); return; } const isPremiumShot = premiumShots > 0; targetCell.classList.add('shot'); if (cellState.shipId) { if (!isPremiumShot) { shots--; } handleHit(targetCell, isPremiumShot); } else { if (isPremiumShot) { premiumShots--; } else { shots--; } if (cellState.prizeId) { handlePrize(targetCell); } else { handleMiss(targetCell); } } updateStats(); checkGameOver(); }
    function handleHit(cellEl, wasPremium) { const row = cellEl.dataset.row, col = cellEl.dataset.col; const hitShip = ships.find(ship => ship.id === boardState[row][col].shipId); if (!hitShip) return; boardState[row][col].state = 'hit'; cellEl.classList.add('hit'); const icon = icons.hit.cloneNode(true); icon.classList.add('icon'); cellEl.appendChild(icon); roundMoney += wasPremium ? 2500 : 500; premiumShots += 1; displayMessage(`TALÁLAT!<br>(${hitShip.size} egységes hajó)`, 1500, () => displayMessage("PRÉMIUM LÖVÉS!", 1500)); hitShip.hits++; if (hitShip.hits === hitShip.size) handleSunkShip(hitShip); }
    function handlePrize(cellEl) { cellEl.classList.add('prize'); const icon = icons.prize.cloneNode(true); icon.classList.add('icon'); cellEl.appendChild(icon); const prize = currentRoundPrizes.find(p => p.id === boardState[cellEl.dataset.row][cellEl.dataset.col].prizeId); if (prize) showPrizeModal(prize); switchPlayer(); }
    function handleMiss(cellEl) { cellEl.classList.add('miss'); const icon = icons.miss.cloneNode(true); icon.classList.add('icon'); cellEl.appendChild(icon); displayMessage("MELLÉ!", 1500); switchPlayer(); }
    function handleSunkShip(sunkShip) { sunkShip.sunk = true; sunkShip.sunkBy = currentPlayer; const pointsAwarded = 1 + sunkShip.size; if (currentPlayer === 1) player1Score += pointsAwarded; else player2Score += pointsAwarded; updatePlayerUI(); roundMoney += 10000; displayMessage(`${sunkShip.name} elsüllyedt!<br>+${pointsAwarded} pont`, 3000); sunkShip.coords.forEach(({ row, col }) => { gameBoardEl.querySelector(`[data-row='${row}'][data-col='${col}']`).classList.add('sunk'); }); renderFleetStatus(); }
    
    // --- Modals, Game Over, and Player Logic ---
    function showPrizeModal(prize) { prizeModal.classList.add('visible'); document.getElementById('prize-name').textContent = prize.name; const btnPoints = document.getElementById('btn-collect-points'); const btnCollect = document.getElementById('btn-collect-prize'); btnPoints.textContent = `${prize.value.toLocaleString()} Ft-ért eladom`; const cashHandler = () => { roundMoney += prize.value; updateStats(); closePrizeModal(); }; const collectHandler = () => { playerInventory.push({ ...prize, heldRounds: 0 }); renderPrizeList(); saveState(); closePrizeModal(); }; btnPoints.onclick = cashHandler; btnCollect.onclick = collectHandler; }
    function closePrizeModal() { prizeModal.classList.remove('visible'); }
    function checkGameOver() { if (!gameOver && ships.every(ship => ship.sunk)) { gameOver = true; premiumShots = 0; updateStats(); setTimeout(startGrandPrizeGame, 1500); } }
    function endGameNoAmmo() { gameOver = true; concludeRound(); }
    function showOutOfAmmoModal() { const canBuy = (totalMoney + roundMoney) >= PRICES.shot; const canSell = playerInventory.length > 0; btnAmmoBuy.style.display = canBuy ? 'block' : 'none'; btnAmmoSell.style.display = canSell ? 'block' : 'none'; if (!canBuy && !canSell) { document.getElementById('ammo-modal-text').textContent = "Nincs elég pénzed lőszerre és nincs mit eladnod. A csatának vége!"; } else { document.getElementById('ammo-modal-text').textContent = "Kapitány, kifogytunk a lőszerből! Mit tegyünk?"; } outOfAmmoModal.classList.add('visible'); }
    
    function startGrandPrizeGame() {
        const container = document.getElementById('grand-prize-ships'); container.innerHTML = '';
        for (let i = 0; i < 10; i++) { container.innerHTML += `<button class="ship-choice" data-index="${i}"><div class="flipper"><div class="front"><svg viewBox="0 0 64 64"><path d="M61.9,25.9c-0.2-0.7-0.9-1.1-1.6-0.9l-7.4,1.9c-2-6.5-8.1-11.4-15.3-11.4h-1.2V9.9c0-2.8-2.2-5-5-5s-5,2.2-5,5v5.6h-1.2 c-7.2,0-13.3,4.9-15.3,11.4l-7.4-1.9c-0.7-0.2-1.4,0.2-1.6,0.9s0.2,1.4,0.9,1.6l7.4,1.9c-0.2,0.9-0.3,1.9-0.3,2.9v1.8H2V48h60V32.3 h-2v-1.8C62.2,28.8,62.2,27.2,61.9,25.9z M32,23.5c4.4,0,8,3.6,8,8s-3.6,8-8,8s-8-3.6-8-8S27.6,23.5,32,23.5z"/></svg></div><div class="back"></div></div></button>`; }
        const shipChoices = document.querySelectorAll('.ship-choice'); const closeBtn = document.getElementById('btn-close-grand-prize'); document.getElementById('grand-prize-result').innerHTML = ""; closeBtn.style.display = 'none';
        const prizePool = [ { type: 'bankrupt', label: 'CSŐD' }, { type: 'sunk', label: 'HAJÓTÖRÉS' }, { type: 'money', value: 25000, label: '+25e Ft' }, { type: 'money', value: 50000, label: '+50e Ft' }, { type: 'money', value: 100000, label: '+100e Ft' }, { type: 'aid', aidType: 'sonar', label: '+1 Szónár' }, { type: 'aid', aidType: 'strike', label: '+1 Csapás' }, { type: 'double', label: '2X PÉNZ' }, { type: 'triple', label: '3X PÉNZ' }, { type: 'safe', label: 'MENTŐCSÓNAK' } ];
        for (let i = prizePool.length - 1; i > 0; i--) { const j = Math.floor(seededRandom() * (i + 1)); [prizePool[i], prizePool[j]] = [prizePool[j], prizePool[i]]; }
        const revealChoice = (choiceIndex) => { let resultText = ""; const result = prizePool[choiceIndex]; if (result.type === 'bankrupt') { totalMoney = 0; roundMoney = 0; playerSonarCharges = 0; playerStrikeCharges = 0; resultText = `TELJES CSŐD! Minden elveszett!`; } else if (result.type === 'sunk') { roundMoney = 0; resultText = `HAJÓTÖRÉS! Elveszett a kör nyereménye!`; } else if (result.type === 'safe') { resultText = `MENTŐCSÓNAK! Megtartottad a kör nyereményét.`; } else if (result.type === 'double') { roundMoney *= 2; resultText = `DUPLÁZÓ! Nyeremény: ${roundMoney.toLocaleString()} Ft!`; } else if (result.type === 'triple') { roundMoney *= 3; resultText = `TRIPLÁZÓ! Nyeremény: ${roundMoney.toLocaleString()} Ft!`; } else if (result.type === 'money') { roundMoney += result.value; resultText = `Készpénz! +${result.value.toLocaleString()} Ft!`; } else if (result.type === 'aid') { if(result.aidType === 'sonar') { playerSonarCharges++; resultText = `Felszerelés! +1 Szónár!`; } else { playerStrikeCharges++; resultText = `Felszerelés! +1 Célzott Csapás!`; } } totalMoney += roundMoney; roundMoney = 0; document.getElementById('grand-prize-result').textContent = resultText; shipChoices[choiceIndex].classList.add('is-flipped'); let delay = 500; shipChoices.forEach((ship, index) => { if(index === choiceIndex) return; setTimeout(() => ship.classList.add('is-flipped'), delay); delay += 100; }); setTimeout(() => { closeBtn.style.display = 'block'; updateStats(); }, delay + 200); };
        const choiceHandler = (e) => { const btn = e.currentTarget; if(btn.classList.contains('is-flipped')) return; const choiceIndex = parseInt(btn.dataset.index); shipChoices.forEach(s => s.removeEventListener('click', choiceHandler)); shipChoices.forEach((ship, index) => { const back = ship.querySelector('.back'); const prize = prizePool[index]; back.className = `back ${prize.type}`; back.textContent = prize.label; }); if (roundMoney > 10000 && seededRandom() < 0.33) { const guaranteedAmount = Math.floor(roundMoney * 0.7 / 1000) * 1000; document.getElementById('temptation-text').textContent = `Biztos vagy a dolgodban? Vagy inkább elfogadsz garantált ${guaranteedAmount.toLocaleString()} Ft-ot?`; document.getElementById('btn-reject-offer').onclick = () => { temptationModal.classList.remove('visible'); revealChoice(choiceIndex); }; document.getElementById('btn-accept-offer').onclick = () => { temptationModal.classList.remove('visible'); totalMoney += guaranteedAmount; roundMoney = 0; updateStats(); revealChoice(choiceIndex); }; setTimeout(() => temptationModal.classList.add('visible'), 500); } else { revealChoice(choiceIndex); } };
        shipChoices.forEach(btn => btn.addEventListener('click', choiceHandler));
        closeBtn.onclick = () => { grandPrizeModal.classList.remove('visible'); concludeRound(); };
        grandPrizeModal.classList.add('visible');
    }
    
    function concludeRound() {
        let winnerMessage;
        if (player1Score > player2Score) {
            winnerMessage = `${player1Name} NYERT!<br>${player1Score} ponttal`;
        } else if (player2Score > player1Score) {
            winnerMessage = `${player2Name} NYERT!<br>${player2Score} ponttal`;
        } else {
            winnerMessage = `DÖNTETLEN!<br>${player1Score} ponttal`;
        }
        displayMessage(winnerMessage, 4000, () => {
            saveState();
            showWaitingScreen();
        });
    }

    function switchPlayer() { currentPlayer = (currentPlayer === 1) ? 2 : 1; updatePlayerUI(); }
    function updatePlayerUI() { player1InfoEl.innerHTML = `${player1Name}: ${player1Score} Pont <span class="lock-icon"></span>`; player2InfoEl.innerHTML = `${player2Name}: ${player2Score} Pont <span class="lock-icon"></span>`; player1InfoEl.classList.toggle('active', currentPlayer === 1); player2InfoEl.classList.toggle('active', currentPlayer === 2); updateLockUI(); }
    function togglePlayerLock(playerNum) { lockedPlayer = (lockedPlayer === playerNum) ? 0 : playerNum; updateLockUI(); }
    function updateLockUI() { player1InfoEl.classList.remove('locked'); player2InfoEl.classList.remove('locked'); document.querySelector('#player1-info .lock-icon').textContent = ''; document.querySelector('#player2-info .lock-icon').textContent = ''; boardWrapperEl.classList.remove('board-locked'); renamePlayersBtn.textContent = "Nevek Módosítása"; if (lockedPlayer === 1) { player1InfoEl.classList.add('locked'); document.querySelector('#player1-info .lock-icon').textContent = '🔒'; renamePlayersBtn.textContent = "Vezérlés Feloldása"; } else if (lockedPlayer === 2) { player2InfoEl.classList.add('locked'); document.querySelector('#player2-info .lock-icon').textContent = '🔒'; renamePlayersBtn.textContent = "Vezérlés Feloldása"; } if (lockedPlayer !== 0 && lockedPlayer !== currentPlayer) { boardWrapperEl.classList.add('board-locked'); } }

    // --- UI, Stats & Shop ---
    function updateStats() { const shipsRemaining = ships ? ships.filter(s => !s.sunk).length : 0; const shipsTotal = ships ? ships.length : 7; const currentMoney = (Number(totalMoney) || 0) + (Number(roundMoney) || 0); shotsEl.textContent = shots; scoreEl.textContent = `${currentMoney.toLocaleString()} Ft`; premiumEl.textContent = premiumShots; shipsLeftEl.textContent = `${shipsRemaining}/${shipsTotal}`; premiumStatEl.classList.toggle('active', premiumShots > 0 && !gameOver); buySonarBtn.disabled = currentMoney < PRICES.sonar; buyStrikeBtn.disabled = currentMoney < PRICES.strike; openBuyShotsBtn.disabled = currentMoney < PRICES.shot; sonarChargesBadge.textContent = playerSonarCharges; strikeChargesBadge.textContent = playerStrikeCharges; useSonarBtn.disabled = playerSonarCharges <= 0; useStrikeBtn.disabled = playerStrikeCharges <= 0; waitingScoreEl.textContent = `${currentMoney.toLocaleString()} Ft`; }
    function displayMessage(text, duration = 2000, callback) { clearTimeout(messageTimeout); const overlay = boardMessageOverlayEl; overlay.innerHTML = text; overlay.style.animation = 'none'; overlay.offsetHeight; overlay.style.animation = `fade-in-out-zoom ${duration / 1000}s ease-in-out forwards`; messageTimeout = setTimeout(() => { if (callback) callback(); }, duration); }
    function purchase(cost, callback) { if (totalMoney + roundMoney >= cost) { let rem = cost; if (roundMoney > 0) { const fromRound = Math.min(roundMoney, rem); roundMoney -= fromRound; rem -= fromRound; } if (rem > 0) { totalMoney -= rem; } callback(); updateStats(); saveState(); } else { displayMessage("Nincs elég pénzed!", 2000); } }
    function updateAmmoCost() { let quantity = parseInt(ammoQuantityInput.value) || 1; if (quantity < 1) { quantity = 1; } ammoQuantityInput.value = quantity; const totalCost = quantity * PRICES.shot; ammoTotalCostEl.textContent = `${totalCost.toLocaleString()} Ft`; buyAmmoConfirmBtn.disabled = totalCost > (totalMoney + roundMoney); }
    ammoQuantityInput.addEventListener('input', updateAmmoCost);
    ammoDecrementBtn.addEventListener('click', () => { if (ammoQuantityInput.value > 1) { ammoQuantityInput.value--; updateAmmoCost(); } });
    ammoIncrementBtn.addEventListener('click', () => { ammoQuantityInput.value++; updateAmmoCost(); });
    openBuyShotsBtn.addEventListener('click', () => { buyAmmoModal.classList.add('visible'); updateAmmoCost(); });
    document.getElementById('btn-buy-ammo-cancel').addEventListener('click', () => buyAmmoModal.classList.remove('visible'));
    buyAmmoConfirmBtn.addEventListener('click', () => { const quantity = parseInt(ammoQuantityInput.value); const totalCost = quantity * PRICES.shot; purchase(totalCost, () => { shots += quantity; displayMessage(`+${quantity} Lőszer`, 2000); buyAmmoModal.classList.remove('visible'); }); });
    buySonarBtn.addEventListener('click', () => purchase(PRICES.sonar, () => { playerSonarCharges++; displayMessage("+1 Szónár", 2000); }));
    buyStrikeBtn.addEventListener('click', () => purchase(PRICES.strike, () => { playerStrikeCharges++; displayMessage("+1 Célzott Csapás", 2000); }));
    useSonarBtn.addEventListener('click', () => { if(playerSonarCharges > 0) { playerSonarCharges--; displayMessage("SZÓNÁR BEVETVE!", 4000); updateStats(); saveState(); } }); 
    useStrikeBtn.addEventListener('click', () => { if(playerStrikeCharges > 0) { playerStrikeCharges--; displayMessage("CÉLZOTT CSAPÁS!", 2000); updateStats(); saveState(); } }); 
    renamePlayersBtn.addEventListener('click', () => { if (lockedPlayer !== 0) { togglePlayerLock(0); return; } const newP1 = prompt("Add meg az 1. Játékos nevét:", player1Name); if (newP1) player1Name = newP1; const newP2 = prompt("Add meg a 2. Játékos nevét:", player2Name); if (newP2) player2Name = newP2; updatePlayerUI(); renderFleetStatus(); });
    player1InfoEl.addEventListener('click', () => togglePlayerLock(1));
    player2InfoEl.addEventListener('click', () => togglePlayerLock(2));
    btnAmmoBuy.addEventListener('click', () => { outOfAmmoModal.classList.remove('visible'); buyAmmoModal.classList.add('visible'); updateAmmoCost(); });
    btnAmmoSell.addEventListener('click', () => { let totalSellValue = 0; playerInventory.forEach(p => { totalSellValue += Math.floor(p.value * (1 + 0.25 * (p.heldRounds || 0))); }); totalMoney += totalSellValue; playerInventory = []; outOfAmmoModal.classList.remove('visible'); displayMessage(`Zsákmány eladva:<br>+${totalSellValue.toLocaleString()} Ft`, 3000); renderPrizeList(); updateStats(); setTimeout(showOutOfAmmoModal, 500); });
    btnAmmoEnd.addEventListener('click', () => { outOfAmmoModal.classList.remove('visible'); endGameNoAmmo(); });

    // --- Time & Layout Management ---
    function handleLayout() { const prizeCorner = document.getElementById('prize-corner'); const mainPanel = document.getElementById('main-panel'); const sidePanel = document.getElementById('side-panel'); if (window.innerWidth <= 900) { if (!sidePanel.contains(prizeCorner)) sidePanel.appendChild(prizeCorner); } else { if (!mainPanel.contains(prizeCorner)) mainPanel.appendChild(prizeCorner); } }
    function tick() { const now = new Date(); const millis = now.getTime(); liveTimeWaitingEl.textContent = now.toLocaleTimeString('hu-HU'); const nextMapTimestamp = (Math.floor(millis / MAP_REFRESH_INTERVAL) + 1) * MAP_REFRESH_INTERVAL; const nextMapDate = new Date(nextMapTimestamp); const timeString = nextMapDate.toLocaleTimeString('hu-HU', { hour: '2-digit', minute: '2-digit' }); waitingTimeEl.textContent = `${timeString}-kor`; const newSeed = Math.floor(millis / MAP_REFRESH_INTERVAL); if (newSeed > currentMapSeed) { if (gameInProgress && !gameOver) { newGameButton.style.display = 'block'; } else if(!gameInProgress) { startNewRound(); } } }
    function startNewRound() { totalMoney += roundMoney; roundMoney = 0; playerInventory.forEach(p => p.heldRounds = (p.heldRounds || 0) + 1); saveState(); initGame(); }

    // --- Initial Load ---
    window.addEventListener('beforeunload', saveState);
    window.addEventListener('resize', handleLayout);
    newGameButton.addEventListener('click', startNewRound);
    loadState();
    setInterval(tick, 1000);
    initGame();
});
</script>
</body>
</html>```
